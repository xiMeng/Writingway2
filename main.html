<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writingway 2.0</title>
    <!-- Note: This file should be named main.html and opened via start.bat -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="src/prompts.js"></script>
    <script defer src="src/generation.js"></script>
    <script defer src="src/ai.js"></script>
    <script defer src="src/save-utils.js"></script>
    <script defer src="src/modules/project-manager.js"></script>
    <script defer src="src/modules/chapter-manager.js"></script>
    <script defer src="src/modules/scene-manager.js"></script>
    <script defer src="src/modules/beat-mentions.js"></script>
    <script defer src="src/modules/compendium-manager.js"></script>
    <script defer src="src/modules/ai-settings.js"></script>
    <script defer src="src/workshop.js"></script>
    <script defer src="src/app.js"></script>
    <script defer src="src/compendium.js"></script>
    <!-- Local vendor Alpine (use a real alpine.min.js here for offline runs) -->
    <script defer src="src/vendor/alpine.min.js"></script>

    <link rel="stylesheet" href="src/styles.css">
</head>

<body>
    <div x-data="app" x-init="init()">
        <!-- debug banner removed -->
        <!-- Main App -->
        <template x-if="currentProject && !showModelLoading">
            <div class="app-container">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-header" style="position:relative;">
                        <h1>Writingway</h1>
                        <p>AI-Powered Creative Writing</p>

                        <!-- Main Menu Button -->
                        <div x-data="{ mainMenuOpen: false }" style="position:absolute;top:12px;right:12px;">
                            <button class="btn btn-secondary" @click.stop="mainMenuOpen = !mainMenuOpen"
                                style="padding:6px 12px;font-size:18px;" title="Main Menu">‚ò∞</button>
                            <div x-show="mainMenuOpen" x-cloak @click.away="mainMenuOpen = false" x-transition
                                class="action-menu" style="right:0;left:auto;min-width:200px;">
                                <button @click.stop="showNewProjectModal = true; mainMenuOpen=false">‚ûï New
                                    Project</button>
                                <button
                                    @click.stop="document.getElementById('importProjectInput').click(); mainMenuOpen=false">üì•
                                    Import Project</button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="exportProject(); mainMenuOpen=false" :disabled="!currentProject">üì¶
                                    Export Current Project</button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="openCompendium(); mainMenuOpen=false">üìö Compendium</button>
                                <button @click.stop="showWorkshopChat = true; mainMenuOpen=false">üí¨ Workshop
                                    Chat</button>
                                <button @click.stop="showAISettings = true; mainMenuOpen=false">‚öôÔ∏è AI Settings</button>
                                <button @click.stop="showPromptsPanel = true; mainMenuOpen=false">üìù Manage
                                    Prompts</button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden file input for import (global scope) -->
                    <input type="file" id="importProjectInput" accept=".zip"
                        @change="importProject($event); $event.target.value = null" style="display:none;">

                    <!-- AI Status -->
                    <div class="ai-status">
                        <div class="ai-status-item"
                            style="cursor:pointer;padding:10px 16px;border-radius:8px;transition:background 0.2s;"
                            @click="showAISettings = !showAISettings"
                            @mouseenter="$el.style.background='rgba(74,158,255,0.1)'"
                            @mouseleave="$el.style.background='transparent'" title="Click to toggle AI settings"
                            aria-label="Toggle AI settings" role="button">
                            <div class="status-dot" :class="aiStatus"></div>
                            <span x-text="aiStatusText"></span>
                            <span style="margin-left:8px;opacity:0.5;font-size:12px;">‚ñº</span>
                        </div>
                    </div>

                    <div class="project-info" x-data="{ openMenu:false }" style="position:relative;">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <h2 style="margin:0;padding-right:8px;">
                                <button class="project-name-button" @click.stop="openCompendium()"
                                    title="Click to toggle Compendium" aria-controls="compendium-panel"
                                    :aria-expanded="showCodexPanel ? 'true' : 'false'"
                                    style="background:none;border:none;padding:8px 12px 8px 0;font-size:1.1em;color:inherit;cursor:pointer;border-radius:6px;transition:background 0.2s;"
                                    @mouseenter="$el.style.background='rgba(74,158,255,0.1)'"
                                    @mouseleave="$el.style.background='transparent'">
                                    <span x-text="currentProject.name"></span>
                                    <span style="margin-left:8px;opacity:0.5;font-size:12px;">üìö</span>
                                </button>
                            </h2>

                            <div style="display:flex;align-items:center;gap:6px;">
                                <button class="menu-button" @click.stop="openMenu = !openMenu"
                                    title="Project menu">‚ãØ</button>
                                <div x-show="openMenu" x-cloak @click.away="openMenu = false" x-transition
                                    class="action-menu">
                                    <button
                                        @click.stop="showRenameProjectModal = true; renameProjectName = currentProject.name; openMenu=false">Rename</button>
                                    <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                    <div style="max-height:200px;overflow:auto;margin-bottom:6px;">
                                        <strong
                                            style="display:block;padding:6px 10px;color:var(--text-secondary);font-size:12px;">Switch
                                            project</strong>
                                        <template x-for="p in projects" :key="p.id">
                                            <button @click.stop="selectProject(p.id); openMenu=false"
                                                style="padding-left:10px;">
                                                <span x-text="p.name"></span>
                                            </button>
                                        </template>
                                    </div>
                                    <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                    <button @click.stop="exportProject(); openMenu=false">üì¶ Export Project</button>
                                    <div style="margin-top:6px"></div>
                                    <button @click.stop="showNewProjectModal = true; openMenu=false">‚ûï New
                                        Project</button>
                                </div>
                            </div>
                        </div>

                        <div class="word-count" x-text="`${totalWords} words`" style="margin-top:6px;"></div>
                    </div>

                    <div class="scene-list">
                        <template x-for="chapter in chapters" :key="chapter.id">
                            <div class="chapter-item">
                                <div class="chapter-header" style="align-items:center;gap:8px;"
                                    x-data="{ openMenu:false }">
                                    <div
                                        style="flex:1;display:flex;justify-content:space-between;align-items:center;position:relative;">
                                        <div @click="chapter.expanded = !chapter.expanded; currentChapter = chapter"
                                            style="flex:1;cursor:pointer;display:flex;align-items:center;gap:8px;">
                                            <div style="flex:1;" x-text="chapter.title"></div>
                                            <div
                                                style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;">
                                                <span x-text="`${chapter.scenes ? chapter.scenes.length : 0}`"></span>
                                                <span class="caret" :class="{ 'rotated': chapter.expanded }">‚ñæ</span>
                                            </div>
                                        </div>

                                        <div class="item-actions" style="margin-left:8px;">
                                            <button class="menu-button" @click.stop="openMenu = !openMenu" title="More">
                                                ‚ãØ
                                            </button>

                                            <div x-show="openMenu" x-cloak @click.away="openMenu = false" x-transition
                                                class="action-menu">
                                                <button @click.stop="moveChapterUp(chapter.id); openMenu=false">Move
                                                    chapter up</button>
                                                <button @click.stop="moveChapterDown(chapter.id); openMenu=false">Move
                                                    chapter down</button>
                                                <button @click.stop="deleteChapter(chapter.id); openMenu=false">Delete
                                                    chapter</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="chapter-scenes" x-show="chapter.expanded">
                                    <template x-for="scene in chapter.scenes" :key="scene.id">
                                        <div class="scene-item"
                                            :class="{ 'active': currentScene && currentScene.id === scene.id }"
                                            @click="loadScene(scene.id)"
                                            :title="`${scene.title}: ${scene.summary ? (scene.summaryStale ? 'Summary outdated' : 'Has summary') : 'No summary yet'}`"
                                            :aria-label="`${scene.title}: ${scene.summary ? (scene.summaryStale ? 'Summary outdated' : 'Has summary') : 'No summary yet'}`"
                                            style="display:flex;justify-content:space-between;align-items:center;">
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="summary-dot"
                                                    :class="{ 'has': scene.summary && !scene.summaryStale, 'stale': scene.summaryStale, 'none': !scene.summary }"
                                                    :title="`${scene.title}: ${scene.summary ? (scene.summaryStale ? 'Summary outdated' : 'Has summary') : 'No summary yet'}`"
                                                    :aria-label="`${scene.title}: ${scene.summary ? (scene.summaryStale ? 'Summary outdated' : 'Has summary') : 'No summary yet'}`"></span>
                                                <div>
                                                    <div class="scene-title" x-text="scene.title"></div>
                                                    <div class="scene-meta" x-text="`${scene.wordCount || 0} words`">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="item-actions" style="margin-left:12px;"
                                                x-data="{ openMenu:false }">
                                                <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                    title="More">
                                                    ‚ãØ
                                                </button>

                                                <div x-show="openMenu" x-cloak @click.away="openMenu = false"
                                                    x-transition class="action-menu">
                                                    <div class="menu-row">
                                                        <label
                                                            style="font-size:12px;color:var(--text-secondary);flex:1;">Move
                                                            to
                                                            <select class="move-select"
                                                                @change.stop="moveSceneToChapter(scene.id, $event.target.value); openMenu=false;">
                                                                <option value="" disabled selected>Choose chapter
                                                                </option>
                                                                <template x-for="ch in chapters" :key="ch.id">
                                                                    <option :value="ch.id"
                                                                        :selected="ch.id === scene.chapterId"
                                                                        x-text="ch.title"></option>
                                                                </template>
                                                            </select>
                                                        </label>
                                                    </div>

                                                    <button @click.stop="moveSceneUp(scene.id); openMenu=false">Move
                                                        up</button>
                                                    <button @click.stop="moveSceneDown(scene.id); openMenu=false">Move
                                                        down</button>
                                                    <button
                                                        @click.stop="openSceneSummary(scene.id); openMenu=false">Summary</button>
                                                    <button @click.stop="deleteScene(scene.id); openMenu=false">Delete
                                                        scene</button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="sidebar-actions"
                        style="display:flex;flex-direction:row;padding:10px;gap:8px;align-items:center;">
                        <button class="add-scene-btn" @click="openNewChapterModal()" aria-label="New chapter"
                            title="New Chapter">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path d="M3 7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"
                                    fill="currentColor" />
                            </svg>
                        </button>

                        <button class="add-scene-btn" @click="openNewSceneModal()" aria-label="New scene"
                            title="New Scene">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path
                                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM14 3.5L18.5 8H15a1 1 0 0 1-1-1V3.5z"
                                    fill="currentColor" />
                                <path d="M8 12h8v2H8v-2zm0 4h5v2H8v-2z" fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Editor -->
                <div class="editor-container">
                    <div class="editor-header">
                        <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                            <div class="editor-title" x-text="currentScene ? currentScene.title : 'No scene selected'">
                            </div>
                            <div class="editor-stats" style="white-space:nowrap;">
                                <span x-text="`${currentSceneWords} words`"></span>
                                <span class="save-indicator" :class="{ 'saving': isSaving }" x-text="saveStatus"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Formatting Toolbar (compact dropdown) -->
                    <div x-show="currentScene" x-cloak x-data="{ formatMenuOpen: false }"
                        style="padding:8px 30px;background:var(--bg-secondary);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;">
                        <span style="font-size:12px;color:var(--text-secondary);">Format:</span>
                        <button @click="formatMenuOpen = !formatMenuOpen" class="btn btn-secondary"
                            style="position:relative;">
                            ‚úé Text Formatting
                        </button>
                        <div x-show="formatMenuOpen" @click.away="formatMenuOpen = false" x-cloak
                            style="position:absolute;top:45px;left:80px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;display:grid;grid-template-columns:1fr 1fr;gap:4px;min-width:280px;">
                            <button @click="applyFormatting('bold'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;font-weight:bold;">
                                <span style="width:20px;display:inline-block;">B</span> Bold
                            </button>
                            <button @click="applyFormatting('italic'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;font-style:italic;">
                                <span style="width:20px;display:inline-block;">I</span> Italic
                            </button>
                            <button @click="applyFormatting('underline'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;text-decoration:underline;">
                                <span style="width:20px;display:inline-block;">U</span> Underline
                            </button>
                            <button @click="applyFormatting('strikethrough'); formatMenuOpen=false"
                                class="btn btn-secondary"
                                style="justify-content:flex-start;text-decoration:line-through;">
                                <span style="width:20px;display:inline-block;">S</span> Strike
                            </button>
                            <button @click="applyFormatting('alignLeft'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">‚â°</span> Align Left
                            </button>
                            <button @click="applyFormatting('alignCenter'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">‚â£</span> Align Center
                            </button>
                            <button @click="applyFormatting('alignRight'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">‚â°</span> Align Right
                            </button>
                            <button @click="applyFormatting('heading'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">H</span> Heading
                            </button>
                            <button @click="applyFormatting('quote'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">"</span> Quote
                            </button>
                            <button @click="applyFormatting('bulletList'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">‚Ä¢</span> Bullet List
                            </button>
                            <button @click="applyFormatting('numberedList'); formatMenuOpen=false"
                                class="btn btn-secondary" style="justify-content:flex-start;">
                                <span style="width:20px;display:inline-block;">#</span> Numbered List
                            </button>
                        </div>
                    </div>

                    <div class="editor-main">
                        <template x-if="currentScene">
                            <div class="editor-textarea" contenteditable="true" @input="onEditorChange"
                                @paste="handlePaste" x-html="currentScene.content" style="outline:none;"
                                data-placeholder="Start writing your scene here...">
                            </div>
                        </template>

                        <template x-if="!currentScene">
                            <div class="welcome-screen">
                                <div class="welcome-content">
                                    <h2>Ready to Write</h2>
                                    <p>Select a scene from the sidebar or create a new one to get started.</p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Beat Panel -->
                    <div class="beat-separator" aria-hidden="true"></div>
                    <div class="beat-panel">
                        <h3>Generate from Beat</h3>
                        <div class="beat-input-group" style="position:relative;">
                            <textarea class="beat-input" x-model="beatInput" @input="onBeatInput($event)"
                                @keydown="onBeatKey($event)"
                                placeholder="Describe what happens next (e.g., 'She grabs her bag and leaves the apartment. She senses tension in the corridor.')"
                                spellcheck="true" rows="2"></textarea>

                            <div class="quick-search-dropdown" x-show="showQuickSearch" x-cloak
                                style="position:relative;width:100%;">
                                <div
                                    style="position:absolute;bottom:100%;left:0;right:0;z-index:5000;background:var(--bg-primary);border:1px solid var(--accent);border-radius:6px;padding:6px;max-height:240px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.4);margin-bottom:8px;">
                                    <template x-for="(m,mi) in quickSearchMatches" :key="m.id">
                                        <div class="quick-search-item"
                                            :class="{ 'active': mi === quickSearchSelectedIndex }"
                                            @click="selectQuickMatch(m)"
                                            style="padding:6px;border-radius:4px;cursor:pointer;">
                                            <div style="font-weight:600" x-text="m.title"></div>
                                            <div style="font-size:12px;color:var(--text-secondary);"
                                                x-text="(m.category || '')"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="scene-search-dropdown" x-show="showSceneSearch" x-cloak
                                style="position:relative;width:100%;">
                                <div
                                    style="position:absolute;bottom:100%;left:0;right:0;z-index:5000;background:var(--bg-primary);border:1px solid var(--accent-blue,#60a5fa);border-radius:6px;padding:6px;max-height:240px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.4);margin-bottom:8px;">
                                    <template x-for="(scene,si) in sceneSearchMatches" :key="scene.id">
                                        <div class="scene-search-item"
                                            :class="{ 'active': si === sceneSearchSelectedIndex }"
                                            @click="selectSceneMatch(scene)"
                                            style="padding:6px;border-radius:4px;cursor:pointer;">
                                            <div style="display:flex;align-items:center;gap:6px;">
                                                <span
                                                    x-text="scene.hasSummary ? (scene.summaryStale ? '‚ö†Ô∏è' : '‚úÖ') : '‚ùå'"
                                                    :title="scene.hasSummary ? (scene.summaryStale ? 'Summary is outdated' : 'Summary available') : 'No summary'"></span>
                                                <span style="font-weight:600" x-text="scene.title"></span>
                                            </div>
                                            <div style="font-size:12px;color:var(--text-secondary);"
                                                x-text="scene.chapterName || 'Unknown Chapter'"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <div class="beat-controls"
                            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:0;">
                            <div class="beat-actions" style="display:flex;gap:8px;align-items:center;">
                                <button class="generate-btn" @click="previewPrompt"
                                    :disabled="!beatInput || aiStatus !== 'ready'">
                                    Preview
                                </button>

                                <button class="generate-btn" @click="generateFromBeat"
                                    :disabled="!beatInput || isGenerating || aiStatus !== 'ready'">
                                    <span x-text="isGenerating ? 'Generating...' : 'Generate'"></span>
                                </button>

                                <button class="generate-btn" @click="showPromptsPanel = !showPromptsPanel"
                                    title="Toggle Prompts Panel" aria-label="Toggle prompts panel">
                                    Prompts
                                </button>

                                <button class="btn btn-secondary" @click="showSceneOptions = !showSceneOptions"
                                    title="Scene options">
                                    ‚öôÔ∏è
                                </button>
                            </div>

                            <div class="scene-options" x-show="showSceneOptions"
                                style="background:var(--bg-tertiary);padding:10px;border-radius:6px;border:1px solid var(--border);width:320px;">
                                <div style="display:flex;flex-direction:column;gap:8px;">
                                    <label style="font-size:12px;color:var(--text-secondary);">POV CHARACTER
                                        <input type="text" x-model="povCharacter" placeholder="e.g., Alice"
                                            list="character-list" @blur="saveScene()"
                                            @keydown.enter.prevent="saveScene()"
                                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                        <datalist id="character-list">
                                            <template
                                                x-for="char in compendiumList.filter(c => c.category === 'characters')"
                                                :key="char.id">
                                                <option :value="char.title"></option>
                                            </template>
                                        </datalist>
                                    </label>

                                    <label style="font-size:12px;color:var(--text-secondary);">POV
                                        <select x-model="pov" @change="saveScene()"
                                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                            <option>3rd person limited</option>
                                            <option>1st person</option>
                                            <option>omniscient</option>
                                        </select>
                                    </label>

                                    <label style="font-size:12px;color:var(--text-secondary);">TENSE
                                        <select x-model="tense" @change="saveScene()"
                                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                            <option value="past">past tense</option>
                                            <option value="present">present tense</option>
                                        </select>
                                    </label>

                                    <label style="font-size:12px;color:var(--text-secondary);">Prose Prompt
                                        <select x-model="selectedProsePromptId"
                                            @change="saveSelectedProsePrompt(selectedProsePromptId)"
                                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                            <option value="">Use current prompt (fallback)</option>
                                            <template x-for="pr in prompts.filter(p => p.category === 'prose')"
                                                :key="pr.id">
                                                <option :value="pr.id" x-text="pr.title"></option>
                                            </template>
                                        </select>
                                    </label>

                                    <!-- Generation Settings -->
                                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                                        <div
                                            style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">
                                            Generation Settings
                                        </div>

                                        <!-- Model Selection -->
                                        <label style="font-size:12px;color:var(--text-secondary);"
                                            title="The AI model used for generation. Different models have different capabilities and costs.">
                                            MODEL
                                            <select x-model="aiModel" @change="saveGenerationParams()"
                                                style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                                <!-- API mode models -->
                                                <template
                                                    x-for="model in (aiMode === 'api' ? (providerModels[aiProvider] || []) : [])"
                                                    :key="model.id">
                                                    <option :value="model.id"
                                                        x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                                    </option>
                                                </template>
                                                <!-- Local mode models -->
                                                <template
                                                    x-for="modelName in (aiMode === 'local' ? availableLocalModels : [])"
                                                    :key="modelName">
                                                    <option :value="modelName" x-text="modelName"></option>
                                                </template>
                                                <!-- Fallback when no local models -->
                                                <option x-show="aiMode === 'local' && availableLocalModels.length === 0"
                                                    value="">No models - Scan in AI Settings</option>
                                            </select>
                                        </label>

                                        <!-- Temperature -->
                                        <label
                                            style="font-size:12px;color:var(--text-secondary);margin-top:12px;display:block;"
                                            title="Controls randomness. Lower (0.3-0.6) = more focused and consistent. Higher (0.8-1.2) = more creative and varied.">
                                            TEMPERATURE: <span x-text="temperature.toFixed(1)"></span>
                                            <input type="range" x-model.number="temperature" min="0.1" max="1.5"
                                                step="0.1" @input="saveGenerationParams()"
                                                style="width:100%;margin-top:6px;">
                                            <div
                                                style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                                <span>Focused</span>
                                                <span>Balanced</span>
                                                <span>Creative</span>
                                            </div>
                                        </label>

                                        <!-- Max Tokens -->
                                        <label
                                            style="font-size:12px;color:var(--text-secondary);margin-top:12px;display:block;"
                                            title="Maximum length of generated text. 100-200 = short paragraph, 300-500 = multiple paragraphs, 800-1500 = longer scenes, 2000 = very long.">
                                            MAX LENGTH: <span x-text="maxTokens"></span> tokens
                                            <input type="range" x-model.number="maxTokens" min="100" max="2000"
                                                step="50" @input="saveGenerationParams()"
                                                style="width:100%;margin-top:6px;">
                                            <div
                                                style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                                <span>Short</span>
                                                <span>Medium</span>
                                                <span>Very Long</span>
                                            </div>
                                        </label>

                                        <!-- Quick link to full AI Settings -->
                                        <button class="btn btn-secondary"
                                            @click="showSceneOptions = false; showAISettings = true"
                                            style="width:100%;margin-top:12px;font-size:11px;">
                                            ‚öôÔ∏è Advanced AI Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="context-info">
                            <span x-show="aiStatus === 'ready'">‚úì AI ready ‚Ä¢ Will use current scene as context</span>
                            <span x-show="aiStatus === 'loading'">‚è≥ Loading model...</span>
                            <span x-show="aiStatus === 'error'">‚ö†Ô∏è Model not loaded (using placeholder text for
                                now)</span>
                        </div>

                        <!-- Generation actions (accept/retry/discard) -->
                        <div style="position:relative;padding:12px 30px 6px;">
                            <div x-show="showGenActions" x-cloak
                                style="position:absolute;right:30px;top:-12px;display:flex;gap:8px;">
                                <button class="btn btn-primary" @click="acceptGeneration">Accept</button>
                                <button class="btn btn-secondary" @click="retryGeneration">Retry</button>
                                <button class="btn btn-secondary" @click="discardGeneration">Discard</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Floating Rewrite button (appears when text selected in scene textarea) -->
        <button x-show="showRewriteBtn" x-cloak @click.prevent="handleRewriteButtonClick()"
            :style="`position:fixed;left:${rewriteBtnX}px;top:${rewriteBtnY}px;z-index:6000;`" class="rewrite-btn">
            Rewrite
        </button>

        <!-- Rewrite Modal -->
        <div x-show="showRewriteModal" x-cloak class="modal-overlay" @click.self="discardRewrite()">
            <div class="rewrite-modal" @click.stop>
                <div class="modal-header">
                    <h3 style="margin:0;">Rewrite Selection</h3>
                    <button class="btn btn-secondary" @click="discardRewrite()">Close</button>
                </div>

                <div class="modal-body">
                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);">Original
                            text</label>
                        <textarea readonly :value="rewriteOriginalText"
                            style="width:100%;height:120px;padding:10px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;resize:vertical;"></textarea>
                    </div>

                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <button class="btn btn-secondary" @click="buildRewritePrompt()"
                            :disabled="rewriteInProgress">Prompt</button>
                        <button class="btn btn-primary" @click="performRewrite()" :disabled="rewriteInProgress">
                            <span x-show="!rewriteInProgress">Rewrite</span>
                            <span x-show="rewriteInProgress">Rewriting...</span>
                        </button>
                    </div>

                    <div x-show="showRewritePromptList" style="margin-bottom:16px;">
                        <label
                            style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);">Select
                            rewrite prompt</label>
                        <select x-model="selectedRewritePromptId" @change="buildRewritePrompt()"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="">Default rewrite prompt</option>
                            <template x-for="pr in prompts.filter(p => p.category === 'rewrite')" :key="pr.id">
                                <option :value="pr.id" x-text="pr.title"></option>
                            </template>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);">Rewritten
                            text</label>
                        <textarea readonly :value="rewriteOutput"
                            style="width:100%;height:180px;padding:10px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;resize:vertical;"
                            placeholder="Rewritten text will appear here..."></textarea>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                        <button class="btn btn-primary" @click="acceptRewrite()"
                            x-show="rewriteOutput && !rewriteInProgress">Accept</button>
                        <button class="btn btn-secondary" @click="retryRewrite()"
                            x-show="rewriteOutput && !rewriteInProgress">Retry</button>
                        <button class="btn btn-secondary" @click="discardRewrite()">Discard</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Loading Screen -->
        <template x-if="showModelLoading">
            <div class="welcome-screen">
                <div class="welcome-content">
                    <h2>Setting Up AI</h2>
                    <p x-text="loadingMessage"></p>
                    <div class="loading-bar">
                        <div class="loading-bar-fill" :style="`width: ${loadingProgress}%`"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px;" x-text="`${loadingProgress}%`"></p>
                    <div class="note" x-show="loadingProgress < 100">
                        This may take a minute on first run while the AI engine initializes...
                    </div>
                </div>
            </div>
        </template>

        <!-- Rewrite modal removed: selecting text shows only the floating Rewrite button -->

        <!-- Welcome Screen (No Project) -->
        <template x-if="!currentProject && !showModelLoading">
            <div class="welcome-screen">
                <div class="welcome-content">
                    <h2>Welcome to Writingway 2.0</h2>
                    <p>A free, open-source creative writing tool with AI assistance. Everything runs locally on your
                        computer.</p>
                    <button class="btn btn-primary" @click="showNewProjectModal = true">
                        Create Your First Project
                    </button>
                    <div class="note">
                        <strong>Note:</strong> AI integration is currently being set up. The app will work without AI,
                        and generation features will use placeholder text until the local model is fully configured.
                    </div>
                </div>
            </div>
        </template>

        <!-- New Project Modal -->
        <template x-if="showNewProjectModal">
            <div class="modal-overlay" @click.self="showNewProjectModal = false">
                <div class="modal">
                    <h3>New Project</h3>
                    <input type="text" x-model="newProjectName" placeholder="Project name (e.g., 'My Novel')"
                        @keydown.enter="createProject">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewProjectModal = false">Cancel</button>
                        <button class="btn btn-primary" @click="createProject">Create</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Rename Project Modal -->
        <template x-if="showRenameProjectModal">
            <div class="modal-overlay" @click.self="showRenameProjectModal = false">
                <div class="modal">
                    <h3>Rename Project</h3>
                    <input type="text" x-model="renameProjectName" placeholder="Project name"
                        @keydown.enter="renameCurrentProject">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showRenameProjectModal = false">Cancel</button>
                        <button class="btn btn-primary" @click="renameCurrentProject">Rename</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Scene Summary Panel -->
        <div class="slide-panel-right summary-panel" :class="{ 'open': showSummaryPanel }" x-cloak aria-hidden="true">
            <div class="slide-panel-header">
                <h3 style="margin:0;">Scene Summary</h3>
                <div>
                    <button class="btn btn-secondary" @click="showSummaryPanel = false">Close</button>
                </div>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;flex-direction:column;height:100%;">
                    <div style="flex:1;overflow:auto;">
                        <textarea x-model="summaryText" rows="12"
                            style="width:100%;margin-top:8px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text-primary);border-radius:6px;resize:vertical;"></textarea>
                    </div>

                    <div
                        style="flex:0 0 auto;display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px;position:relative;">
                        <!-- Prompt Selection Button -->
                        <div style="position:relative;">
                            <button class="btn btn-secondary" @click="showSummaryPromptList = !showSummaryPromptList"
                                title="Choose a summary prompt">
                                Prompt
                            </button>
                            <!-- Prompt Dropdown -->
                            <div x-show="showSummaryPromptList" @click.away="showSummaryPromptList = false" x-cloak
                                style="position:absolute;bottom:100%;left:0;margin-bottom:8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:8px;min-width:280px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:1000;">
                                <div
                                    style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;padding:4px 8px;">
                                    Select Summary Prompt:
                                </div>
                                <!-- Default option -->
                                <div @click="selectedSummaryPromptId = null; showSummaryPromptList = false"
                                    :style="!selectedSummaryPromptId ? 'background:var(--accent);color:white;' : ''"
                                    style="padding:8px 12px;cursor:pointer;border-radius:4px;margin-bottom:4px;transition:background 0.15s;"
                                    :class="!selectedSummaryPromptId ? '' : 'hover:bg-tertiary'">
                                    <div style="font-weight:600;font-size:13px;">
                                        Default
                                        <span x-show="prompts.filter(p => p.category === 'summary').length === 0"
                                            style="font-size:11px;opacity:0.7;">(Heuristic)</span>
                                    </div>
                                    <div style="font-size:11px;opacity:0.8;">
                                        <span x-show="prompts.filter(p => p.category === 'summary').length > 0">First
                                            summary prompt or fallback</span>
                                    </div>
                                </div>
                                <!-- Summary category prompts -->
                                <template x-for="prompt in prompts.filter(p => p.category === 'summary')"
                                    :key="prompt.id">
                                    <div @click="selectedSummaryPromptId = prompt.id; showSummaryPromptList = false"
                                        :style="selectedSummaryPromptId === prompt.id ? 'background:var(--accent);color:white;' : ''"
                                        style="padding:8px 12px;cursor:pointer;border-radius:4px;margin-bottom:4px;transition:background 0.15s;"
                                        @mouseenter="$el.style.background = selectedSummaryPromptId === prompt.id ? 'var(--accent)' : 'var(--bg-secondary)'"
                                        @mouseleave="$el.style.background = selectedSummaryPromptId === prompt.id ? 'var(--accent)' : 'transparent'">
                                        <div style="font-weight:600;font-size:13px;" x-text="prompt.title"></div>
                                        <div style="font-size:11px;opacity:0.8;"
                                            x-text="(prompt.content || '').slice(0, 60) + '...'"></div>
                                    </div>
                                </template>
                                <!-- No prompts message -->
                                <div x-show="prompts.filter(p => p.category === 'summary').length === 0"
                                    style="padding:12px;text-align:center;color:var(--text-secondary);font-size:12px;">
                                    No summary prompts yet.<br>
                                    <span style="font-size:11px;opacity:0.7;">Add one in the Prompts panel</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" @click="summarizeScene">Summarize</button>
                        <button class="btn btn-primary" @click="saveSceneSummary">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Settings Panel -->
        <div class="slide-panel-right" :class="{ 'open': showAISettings }" x-cloak
            style="width:600px;border-left:1px solid rgba(74,158,255,0.08);box-shadow:-18px 0 40px rgba(0,0,0,0.55);">
            <div class="slide-panel-header">
                <h3 style="margin:0;">AI Configuration</h3>
                <button class="btn btn-secondary" @click="showAISettings = false">Close</button>
            </div>
            <div class="slide-panel-body" style="overflow-y:auto;">
                <!-- Mode Selection -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text-primary);">AI
                        Mode</label>
                    <div style="display:flex;gap:12px;">
                        <button class="btn" :class="aiMode === 'api' ? 'btn-primary' : 'btn-secondary'"
                            @click="aiMode = 'api'; if (aiProvider === 'openrouter' && !aiModel) aiModel = 'google/gemini-2.0-flash-exp:free';"
                            style="flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;">
                            <div style="font-size:20px;margin-bottom:4px;">‚òÅÔ∏è</div>
                            <div style="font-weight:600;">API (Cloud)</div>
                            <div style="font-size:11px;opacity:0.7;">No setup required</div>
                        </button>
                        <button class="btn" :class="aiMode === 'local' ? 'btn-primary' : 'btn-secondary'"
                            @click="aiMode = 'local'; if (availableLocalModels.length > 0 && !aiModel) aiModel = availableLocalModels[0]; scanLocalModels();"
                            style="flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;">
                            <div style="font-size:20px;margin-bottom:4px;">üíª</div>
                            <div style="font-weight:600;">Local Model</div>
                            <div style="font-size:11px;opacity:0.7;">Privacy & offline</div>
                        </button>
                    </div>
                </div>

                <!-- API Mode Settings -->
                <div x-show="aiMode === 'api'" style="margin-bottom:20px;">
                    <h4 style="margin:0 0 12px 0;">API Provider Settings</h4>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">Provider</label>
                        <select x-model="aiProvider"
                            @change="aiModel = (providerModels[aiProvider] && providerModels[aiProvider].length > 0) ? providerModels[aiProvider].find(m => m.recommended)?.id || providerModels[aiProvider][0].id : ''; modelsFetched = false;"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="openrouter">OpenRouter (Multi-model, has free options)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="google">Google AI (Gemini)</option>
                            <option value="custom">Custom API Endpoint</option>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">API
                            Key</label>
                        <input type="password" x-model="aiApiKey" placeholder="Enter your API key"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;">
                            <template x-if="aiProvider === 'openrouter'">Get a free key at <a
                                    href="https://openrouter.ai/keys" target="_blank"
                                    style="color:var(--accent);">openrouter.ai/keys</a></template>
                            <template x-if="aiProvider === 'anthropic'">Get your key at <a
                                    href="https://console.anthropic.com/" target="_blank"
                                    style="color:var(--accent);">console.anthropic.com</a></template>
                            <template x-if="aiProvider === 'openai'">Get your key at <a
                                    href="https://platform.openai.com/api-keys" target="_blank"
                                    style="color:var(--accent);">platform.openai.com/api-keys</a></template>
                            <template x-if="aiProvider === 'google'">Get your key at <a
                                    href="https://makersuite.google.com/app/apikey" target="_blank"
                                    style="color:var(--accent);">Google AI Studio</a></template>
                        </p>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <label
                                style="display:block;font-size:13px;font-weight:600;color:var(--text-primary);">Model</label>
                            <button class="btn btn-secondary" @click="fetchProviderModels()"
                                :disabled="!aiApiKey || fetchingModels" style="font-size:11px;padding:4px 8px;"
                                title="Refresh available models from provider">
                                <span x-show="!fetchingModels">üîÑ Refresh</span>
                                <span x-show="fetchingModels">‚è≥ Loading...</span>
                            </button>
                        </div>
                        <select x-model="aiModel"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="" disabled>Select a model...</option>
                            <template x-for="model in providerModels[aiProvider] || []" :key="model.id">
                                <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                </option>
                            </template>
                        </select>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;"
                            x-show="modelsFetched && aiMode === 'api'">
                            ‚úì Model list updated from provider
                        </p>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;"
                            x-show="!aiApiKey && aiMode === 'api'">
                            ‚ÑπÔ∏è Enter API key above to see available models
                        </p>
                    </div>

                    <div x-show="aiProvider === 'custom'" style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">Custom
                            Endpoint URL</label>
                        <input type="text" x-model="aiEndpoint"
                            placeholder="https://api.example.com/v1/chat/completions"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                    </div>
                </div>

                <!-- Local Mode Settings -->
                <div x-show="aiMode === 'local'" style="margin-bottom:20px;">
                    <h4 style="margin:0 0 12px 0;">Local Model Settings</h4>

                    <div
                        style="background:rgba(74,158,255,0.05);border:1px solid rgba(74,158,255,0.2);border-radius:6px;padding:12px;margin-bottom:16px;">
                        <p style="font-size:12px;color:var(--text-secondary);margin:0;">üìÅ Place your GGUF model
                            files in the <code
                                style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">/models</code>
                            folder, then click "Scan for Models" below.</p>
                    </div>

                    <button class="btn btn-secondary" @click="scanLocalModels()" style="margin-bottom:16px;">üîç Scan for
                        Models</button>

                    <div style="margin-bottom:16px;" x-show="availableLocalModels.length > 0">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">Select
                            Model</label>
                        <select x-model="aiModel"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="">Choose a model...</option>
                            <template x-for="model in availableLocalModels" :key="model">
                                <option :value="model" x-text="model"></option>
                            </template>
                        </select>
                    </div>

                    <div x-show="availableLocalModels.length === 0"
                        style="padding:12px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:6px;">
                        <p style="font-size:12px;color:var(--text-secondary);margin:0;">‚ö†Ô∏è No models found. Please add
                            GGUF files to the /models folder, then restart using start.bat</p>
                    </div>

                    <div x-show="availableLocalModels.length > 0"
                        style="margin-top:12px;padding:10px;background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.3);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:0;line-height:1.5;">
                            üí° <strong>Note:</strong> Changing models requires restarting Writingway via <code
                                style="background:rgba(0,0,0,0.2);padding:2px 4px;border-radius:3px;">start.bat</code>
                            <br>‚Ä¢ GPU-enabled llama.cpp loads models in ~3 seconds
                            <br>‚Ä¢ CPU-only version can take several minutes
                        </p>
                    </div>

                    <div style="margin-top:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">Server
                            URL</label>
                        <input type="text" x-model="aiEndpoint" value="http://localhost:8080"
                            placeholder="http://localhost:8080"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;">The llama-server
                            endpoint (usually localhost:8080)</p>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="display:flex;gap:8px;padding-top:16px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" @click="saveAISettings()">üíæ Save & Test Connection</button>
                    <button class="btn btn-secondary" @click="showAISettings = false">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Prompts Slide Panel -->
        <div class="slide-panel-right prompts-panel" :class="{ 'open': showPromptsPanel }" x-cloak aria-hidden="true">
            <div class="slide-panel-header">
                <h3 style="margin:0;">Prompts</h3>
                <div>
                    <button class="btn btn-secondary" @click="showPromptsPanel = false">Close</button>
                </div>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;gap:12px;height:100%;">
                    <div style="width:40%;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="color:var(--text-primary);">Categories</strong>
                        </div>

                        <template x-for="cat in promptCategories" :key="cat">
                            <div style="margin-bottom:12px;">
                                <div class="comp-category" :class="{ 'active': promptCollapsed[cat] === false }"
                                    tabindex="0" role="button" @click="promptCollapsed[cat] = !promptCollapsed[cat]">
                                    <div class="comp-category-label" style="text-transform:capitalize;" x-text="cat">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:6px;">
                                        <div class="comp-category-count"
                                            style="font-size:12px;color:var(--text-secondary);"
                                            x-text="(prompts.filter(p => p.category === cat) || []).length"></div>
                                        <button class="btn btn-secondary" style="padding:2px 8px;font-size:14px;"
                                            @click.stop="createPrompt(cat)">+</button>
                                    </div>
                                </div>

                                <div x-show="!promptCollapsed[cat]" x-cloak style="margin-top:6px;">
                                    <template x-for="pr in prompts.filter(p => p.category === cat)" :key="pr.id">
                                        <div class="comp-entry"
                                            :class="{ 'active': currentPrompt && currentPrompt.id === pr.id }"
                                            tabindex="0">
                                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                                <div style="flex:1;cursor:pointer;" @click.stop="openPrompt(pr.id)">
                                                    <div class="comp-entry-title" x-text="pr.title"></div>
                                                    <div class="comp-entry-meta"
                                                        style="font-size:11px;color:var(--text-secondary);"
                                                        x-text="new Date(pr.modified).toLocaleString()"></div>
                                                </div>

                                                <div class="item-actions" style="margin-left:8px;"
                                                    x-data="{ openMenu:false }">
                                                    <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                        title="More">‚ãØ</button>
                                                    <div x-show="openMenu" x-cloak @click.away="openMenu = false"
                                                        x-transition class="action-menu">
                                                        <button @click.stop="movePromptUp(pr.id); openMenu=false">Move
                                                            up</button>
                                                        <button @click.stop="movePromptDown(pr.id); openMenu=false">Move
                                                            down</button>
                                                        <button
                                                            @click.stop="renamePrompt(pr.id); openMenu=false">Rename</button>
                                                        <button
                                                            @click.stop="deletePrompt(pr.id); openMenu=false">Delete</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div style="flex:1;display:flex;flex-direction:column;">
                        <div style="flex:0 0 auto;margin-bottom:6px;">
                            <div x-show="!currentPrompt" style="color:var(--text-secondary);">Select a prompt or create
                                a new one.</div>
                            <div x-show="currentPrompt">
                                <input type="text" x-model="currentPrompt.title"
                                    style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;margin-bottom:6px;">
                                <div style="margin-bottom:6px;">
                                    <label
                                        style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">Category</label>
                                    <select x-model="currentPrompt.category"
                                        style="width:100%;padding:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                                        <template x-for="cat in promptCategories" :key="cat">
                                            <option :value="cat" x-text="cat" style="text-transform:capitalize;">
                                            </option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="flex:1;overflow:auto;">
                            <textarea x-model="promptEditorContent"
                                style="width:100%;height:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;"></textarea>
                        </div>
                        <div style="flex:0 0 auto;display:flex;gap:8px;margin-top:8px;">
                            <button class="btn btn-primary" @click="savePrompt" :disabled="!currentPrompt">Save</button>
                            <button class="btn btn-secondary" @click="deletePrompt(currentPrompt.id)"
                                x-show="currentPrompt">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compendium Slide Panel -->
        <div id="compendium-panel" class="slide-panel-right compendium-panel" :class="{ 'open': showCodexPanel }"
            x-cloak :aria-hidden="!showCodexPanel">
            <div class="slide-panel-header">
                <h3 style="margin:0;">Compendium</h3>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;gap:12px;height:100%;">
                    <div style="width:40%;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="color:var(--text-primary);">Categories</strong>
                        </div>

                        <template x-for="cat in compendiumCategories" :key="cat">
                            <div style="margin-bottom:12px;">
                                <div class="comp-category" :class="{ 'active': currentCompCategory === cat }"
                                    tabindex="0" role="button" @click="loadCompendiumCategory(cat)"
                                    @keydown.enter="loadCompendiumCategory(cat)">
                                    <div class="comp-category-label"
                                        style="text-transform:capitalize;font-weight:700;color:var(--text-primary);"
                                        x-text="cat"></div>
                                    <div style="display:flex;align-items:center;gap:6px;">
                                        <div class="comp-category-count"
                                            style="font-size:12px;color:var(--text-secondary);"
                                            x-text="(compendiumCounts[cat] || 0)"></div>
                                        <button class="btn btn-secondary" style="padding:2px 8px;font-size:14px;"
                                            @click.stop="createCompendiumEntry(cat)"
                                            :title="`New ${cat} entry`">+</button>
                                    </div>
                                </div>
                                <div x-show="currentCompCategory === cat" x-cloak style="margin-top:6px;">
                                    <template x-for="e in compendiumList" :key="e.id">
                                        <div class="comp-entry"
                                            :class="{ 'active': currentCompEntry && currentCompEntry.id === e.id }"
                                            tabindex="0">
                                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                                <div style="flex:1;cursor:pointer;" @click="selectCompendiumEntry(e.id)"
                                                    @keydown.enter="selectCompendiumEntry(e.id)">
                                                    <div class="comp-entry-title" x-text="e.title"></div>
                                                    <div class="comp-entry-meta"
                                                        x-text="new Date(e.modified).toLocaleString()"></div>
                                                </div>

                                                <div class="item-actions" style="margin-left:8px;"
                                                    x-data="{ openMenu:false }">
                                                    <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                        title="More">‚ãØ</button>
                                                    <div x-show="openMenu" x-cloak @click.away="openMenu = false"
                                                        x-transition class="action-menu">
                                                        <div class="menu-row">
                                                            <label
                                                                style="font-size:12px;color:var(--text-secondary);flex:1;display:flex;gap:6px;align-items:center;">
                                                                Move to
                                                                <select class="move-select"
                                                                    @change.stop="moveCompendiumEntryToCategory(e.id, $event.target.value); openMenu=false;">
                                                                    <option value="" disabled selected>Choose category
                                                                    </option>
                                                                    <template x-for="cat in compendiumCategories"
                                                                        :key="cat">
                                                                        <option :value="cat"
                                                                            :selected="cat === e.category" x-text="cat">
                                                                        </option>
                                                                    </template>
                                                                </select>
                                                            </label>
                                                        </div>
                                                        <button
                                                            @click.stop="moveCompendiumEntryUp(e.id); openMenu=false">Move
                                                            up</button>
                                                        <button
                                                            @click.stop="moveCompendiumEntryDown(e.id); openMenu=false">Move
                                                            down</button>
                                                        <button
                                                            @click.stop="deleteCompendiumEntry(e.id); openMenu=false">Delete
                                                            entry</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div style="flex:1;display:flex;flex-direction:column;">
                        <div style="flex:0 0 auto;margin-bottom:6px;">
                            <template x-if="!currentCompEntry">
                                <div style="color:var(--text-secondary);">Select an entry or create a new one.</div>
                            </template>
                            <template x-if="currentCompEntry">
                                <div>
                                    <input type="text" x-model="currentCompEntry.title" placeholder="Entry title"
                                        style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;margin-bottom:6px;">
                                </div>
                            </template>
                        </div>
                        <div style="flex:1;overflow:auto;">
                            <template x-if="currentCompEntry">
                                <div class="comp-editor-vertical">
                                    <!-- Image under the title -->
                                    <label class="comp-image-preview comp-image-block" tabindex="0"
                                        @click.prevent="$refs.compImageInput.click()" @dragover.prevent
                                        @drop.prevent="setCompImageFromFile($event)">
                                        <template x-if="currentCompEntry.imageUrl">
                                            <img :src="currentCompEntry.imageUrl" alt="Entry image preview"
                                                @click.stop="confirmRemoveCompImage()">
                                        </template>
                                        <template x-if="!currentCompEntry.imageUrl">
                                            <div class="comp-image-placeholder">Drop an image here</div>
                                        </template>
                                        <input x-ref="compImageInput" type="file" accept="image/*"
                                            @change="setCompImageFromFile($event)" style="display:none">
                                    </label>

                                    <!-- Body below the image -->
                                    <textarea x-model="currentCompEntry.body"
                                        placeholder="Write compendium entry body here" class="comp-editor-body"
                                        style="margin-top:12px;"></textarea>

                                    <!-- Tags and image remove button -->
                                    <div
                                        style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px;">
                                        <div class="comp-tags">
                                            <div class="tag-list">
                                                <template x-for="(t,ti) in (currentCompEntry.tags || [])" :key="ti">
                                                    <span class="tag-chip" @click.stop="removeCompTag(ti)"
                                                        title="Remove tag" x-text="t"></span>
                                                </template>
                                            </div>
                                            <input class="tag-input" x-model="newCompTag"
                                                placeholder="Add tag and press Enter"
                                                @keydown.enter.prevent="addCompTag()">
                                        </div>

                                        <div style="display:flex;gap:8px;align-items:center;">
                                            <!-- Image removal handled by clicking the image itself -->
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div style="flex:0 0 auto;display:flex;gap:8px;margin-top:8px;align-items:center;">
                            <button class="btn btn-primary" @click="saveCompendiumEntry"
                                :disabled="!currentCompEntry">Save</button>
                            <span style="margin-left:8px;font-size:13px;color:var(--text-secondary);"
                                class="compendium-save-status"
                                :class="{ 'saving': compendiumSaveStatus === 'Saving...' }"
                                x-text="compendiumSaveStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Scene Modal -->
        <template x-if="showNewSceneModal">
            <div class="modal-overlay" @click.self="showNewSceneModal = false">
                <div class="modal">
                    <h3>New Scene</h3>
                    <input type="text" x-model="newSceneName" placeholder="Scene name (e.g., 'Opening')"
                        @keydown.enter="createScene">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewSceneModal = false">Cancel</button>
                        <button class="btn btn-primary" @click="createScene">Create</button>
                    </div>
                </div>
            </div>
        </template>
        <!-- New Chapter Modal -->
        <template x-if="showNewChapterModal">
            <div class="modal-overlay" @click.self="showNewChapterModal = false">
                <div class="modal">
                    <h3>New Chapter</h3>
                    <input type="text" x-model="newChapterName" placeholder="Chapter name (e.g., 'Chapter 1')"
                        @keydown.enter="createChapter">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewChapterModal = false">Cancel</button>
                        <button class="btn btn-primary" @click="createChapter">Create</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Workshop Chat Modal -->
        <template x-if="showWorkshopChat">
            <div class="modal-overlay" @click.self="showWorkshopChat = false" style="z-index:9000;"
                x-init="await loadWorkshopSessions(); if (!workshopSessions || workshopSessions.length === 0) { workshopSessions = [window.workshopChat.createNewSession($data)]; await saveWorkshopSessions(); }">
                <div class="workshop-chat-container">
                    <!-- Left: Sessions List -->
                    <div class="workshop-sessions">
                        <div class="workshop-sessions-header">
                            <h4 style="margin:0;font-size:14px;">Conversations</h4>
                            <button class="btn btn-secondary btn-sm" @click="createWorkshopSession"
                                title="New Chat">+</button>
                        </div>
                        <div class="workshop-sessions-list">
                            <template x-for="(session, idx) in workshopSessions" :key="session.id">
                                <div class="workshop-session-item"
                                    :class="{ 'active': idx === currentWorkshopSessionIndex }"
                                    @click="currentWorkshopSessionIndex = idx">
                                    <span x-text="session.name"></span>
                                    <button class="btn-icon-sm" @click.stop="deleteWorkshopSession(idx)"
                                        title="Delete">√ó</button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Center: Chat Area -->
                    <div class="workshop-chat-main">
                        <!-- Header -->
                        <div class="workshop-chat-header">
                            <div style="display:flex;align-items:center;gap:12px;flex:1;flex-wrap:wrap;">
                                <h3 style="margin:0;font-size:18px;">Workshop Chat</h3>
                                <select x-model="aiModel" @change="saveGenerationParams()" class="workshop-select"
                                    title="AI Model for this chat">
                                    <template
                                        x-for="model in (aiMode === 'api' ? (providerModels[aiProvider] || []) : [])"
                                        :key="model.id">
                                        <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                        </option>
                                    </template>
                                    <template x-for="modelName in (aiMode === 'local' ? availableLocalModels : [])"
                                        :key="modelName">
                                        <option :value="modelName" x-text="modelName"></option>
                                    </template>
                                    <option x-show="aiMode === 'local' && availableLocalModels.length === 0" value="">No
                                        models</option>
                                </select>
                                <select x-model="selectedWorkshopPromptId" @change="saveSelectedWorkshopPrompt"
                                    class="workshop-select">
                                    <option value="">Default Workshop Prompt</option>
                                    <template x-for="p in prompts.filter(p => p.category === 'workshop')" :key="p.id">
                                        <option :value="p.id" x-text="p.title"></option>
                                    </template>
                                </select>
                                <select x-model="workshopFidelityMode" class="workshop-select">
                                    <option value="high">High Fidelity</option>
                                    <option value="balanced">Balanced</option>
                                    <option value="compressed">Compressed</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" @click="showWorkshopChat = false">Close</button>
                        </div>

                        <!-- Messages -->
                        <div class="workshop-messages" id="workshopMessages">
                            <template
                                x-if="workshopSessions[currentWorkshopSessionIndex] && workshopSessions[currentWorkshopSessionIndex].messages.length === 0">
                                <div class="workshop-empty-state">
                                    <p style="color:var(--text-secondary);margin:0;">Start a conversation with the
                                        AI!</p>
                                    <p style="color:var(--text-secondary);font-size:13px;margin:8px 0 0 0;">
                                        Use <code>@name</code> to reference compendium entries or <code>#scene</code>
                                        to reference scenes.
                                    </p>
                                </div>
                            </template>
                            <template x-if="workshopSessions[currentWorkshopSessionIndex]">
                                <template x-for="(msg, idx) in workshopSessions[currentWorkshopSessionIndex].messages"
                                    :key="idx">
                                    <div class="workshop-message" :class="`workshop-message-${msg.role}`">
                                        <div class="workshop-message-role"
                                            x-text="msg.role === 'user' ? 'You' : 'Assistant'"></div>
                                        <div class="workshop-message-content">
                                            <template x-if="msg.content">
                                                <span x-text="msg.content"></span>
                                            </template>
                                            <template
                                                x-if="!msg.content && msg.role === 'assistant' && workshopIsGenerating">
                                                <span class="typing-indicator">‚óè‚óè‚óè</span>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </template>
                        </div>

                        <!-- Input Area -->
                        <div class="workshop-input-area">
                            <div class="workshop-input-wrapper" style="position:relative;">
                                <textarea x-model="workshopInput"
                                    @input="window.workshopChat.onWorkshopInput($data, $event)"
                                    @keydown="window.workshopChat.handleWorkshopKeydown($data, $event)"
                                    @keydown.enter.prevent="
                                        if (!$event.shiftKey && workshopInput.trim() && !showWorkshopQuickSearch && !showWorkshopSceneSearch) {
                                            window.workshopChat.sendMessage($data, workshopInput);
                                        }
                                    " placeholder="Type your message... (Use @name for compendium, #scene for scenes)"
                                    rows="3" class="workshop-textarea" :disabled="workshopIsGenerating"></textarea>

                                <!-- Compendium Quick Search Dropdown -->
                                <div x-show="showWorkshopQuickSearch" x-cloak class="quick-search-dropdown"
                                    style="position:absolute;bottom:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-primary);border-radius:4px;margin-bottom:4px;z-index:9999;">
                                    <template x-for="(item, idx) in workshopQuickSearchMatches" :key="item.id">
                                        <div class="quick-search-item"
                                            @click="window.workshopChat.selectWorkshopQuickMatch($data, item)"
                                            :class="{ 'active': idx === workshopQuickSearchSelectedIndex }"
                                            style="padding:8px;cursor:pointer;font-size:13px;">
                                            <div style="font-weight:600;" x-text="item.title"></div>
                                            <div style="font-size:11px;color:var(--text-secondary);"
                                                x-text="item.category"></div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Scene Search Dropdown -->
                                <div x-show="showWorkshopSceneSearch" x-cloak class="scene-search-dropdown"
                                    style="position:absolute;bottom:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-primary);border-radius:4px;margin-bottom:4px;z-index:9999;">
                                    <template x-for="(scene, idx) in workshopSceneSearchMatches" :key="scene.id">
                                        <div class="scene-search-item"
                                            @click="window.workshopChat.selectWorkshopSceneMatch($data, scene)"
                                            :class="{ 'active': idx === workshopSceneSearchSelectedIndex }"
                                            style="padding:8px;cursor:pointer;font-size:13px;">
                                            <div style="font-weight:600;" x-text="scene.title"></div>
                                            <div style="font-size:11px;color:var(--text-secondary);">
                                                <template x-if="scene.summary">
                                                    <span x-text="scene.summary.substring(0, 60) + '...'"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <button class="btn btn-primary"
                                    @click="window.workshopChat.sendMessage($data, workshopInput)"
                                    :disabled="!workshopInput.trim() || workshopIsGenerating"
                                    style="align-self:flex-end;margin-top:8px;">
                                    <span x-show="!workshopIsGenerating">Send</span>
                                    <span x-show="workshopIsGenerating">Sending...</span>
                                </button>
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:6px;">
                                Press Enter to send, Shift+Enter for new line. Type @ for compendium, # for scenes.
                            </div>
                        </div>
                    </div>

                    <!-- Right: Context Panel (Optional - can be toggled) -->
                    <div class="workshop-context" x-show="showWorkshopContext" x-cloak>
                        <div class="workshop-context-header">
                            <h4 style="margin:0;font-size:14px;">Quick Reference</h4>
                            <button class="btn-icon-sm" @click="showWorkshopContext = false">√ó</button>
                        </div>
                        <div class="workshop-context-content">
                            <p style="font-size:13px;color:var(--text-secondary);">
                                Mentioned items will appear here for quick reference.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>


</body>

</html>