<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="(locale, t('app.title'))"></title>
    <!-- Note: This file should be named main.html and opened via start.bat -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Phase 1 Refactoring: Database and test helpers extracted -->
    <script defer src="src/db.js"></script>
    <script defer src="src/test-helpers.js"></script>
    <!-- Phase 2 Refactoring: State management extracted -->
    <script defer src="src/state/app-state.js"></script>
    <script defer src="src/state/watchers.js"></script>
    <!-- Phase 3 Refactoring: Editor functionality extracted -->
    <script defer src="src/modules/editor.js"></script>
    <!-- Phase 4 Refactoring: Context panel extracted -->
    <script defer src="src/modules/context-panel.js"></script>
    <script defer src="src/generation.js"></script>
    <script defer src="src/prompts.js"></script>
    <script defer src="src/i18n.js"></script>
    <script defer src="src/ai.js"></script>
    <script defer src="src/save-utils.js"></script>
    <script defer src="src/modules/project-manager.js"></script>
    <script defer src="src/modules/chapter-manager.js"></script>
    <script defer src="src/modules/scene-manager.js"></script>
    <script defer src="src/modules/beat-mentions.js"></script>
    <script defer src="src/modules/compendium-manager.js"></script>
    <script defer src="src/modules/ai-settings.js"></script>
    <script defer src="src/modules/github-backup.js"></script>
    <script defer src="src/modules/tab-sync.js"></script>
    <script defer src="src/template-loader.js"></script>
    <script defer src="src/workshop.js"></script>
    <script defer src="src/modules/workshop.js"></script>
    <script defer src="src/update-checker.js"></script>
    <script defer src="src/tts.js"></script>
    <script defer src="src/w1-importer.js"></script>
    <script defer src="src/app.js"></script>
    <script defer src="src/compendium.js"></script>
    <!-- Local vendor Alpine (use a real alpine.min.js here for offline runs) -->
    <script defer src="src/vendor/alpine.min.js"></script>

    <link rel="stylesheet" href="src/styles.css">
</head>

<body>
    <!-- Initial Loading Screen -->
    <div id="loadingScreen"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #1a1f2e 0%, #2d1b3d 100%);display:flex;align-items:center;justify-content:center;z-index:99999;transition:opacity 0.5s ease-out;">
        <div style="text-align:center;max-width:500px;padding:40px;">
            <div style="font-size:48px;margin-bottom:24px;">‚úçÔ∏è</div>
            <h1 style="margin:0 0 16px 0;color:#4a9eff;font-size:32px;font-weight:700;" x-text="(locale, t('app.title'))"></h1>
            <p id="loadingStatus" style="color:rgba(255,255,255,0.8);font-size:16px;margin:16px 0;min-height:24px;" x-text="(locale, t('loading.starting'))"></p>

            <!-- Loading bar -->
            <div
                style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin:24px 0;">
                <div id="loadingBar"
                    style="height:100%;background:linear-gradient(90deg, #4a9eff, #60a5fa);width:0%;transition:width 0.3s ease-out;">
                </div>
            </div>

            <p style="color:rgba(255,255,255,0.5);font-size:13px;line-height:1.6;margin:16px 0 0 0;">
                <span id="loadingTip" x-text="(locale, t('loading.workspace'))"></span>
            </p>
        </div>
    </div>

    <div x-data="app" x-init="init()">
        <!-- Projects Landing Page -->
        <template x-if="showProjectsView && !showModelLoading">
            <div
                style="min-height:100vh;background:linear-gradient(135deg, #1a1f2e 0%, #2d1b3d 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;position:relative;">
                <!-- Header with Settings -->
                <div style="position:absolute;top:20px;right:20px;">
                    <button class="btn btn-secondary" @click="showAISettings = true" style="padding:8px 16px;"
                        :title="(locale, t('btn.settings'))"><span>‚öôÔ∏è</span> <span x-text="(locale, t('btn.settings'))"></span></button>
                </div>

                <!-- Title -->
                <div style="text-align:center;margin-bottom:40px;">
                    <div style="font-size:64px;margin-bottom:16px;">‚úçÔ∏è</div>
                    <h1 style="margin:0 0 8px 0;color:#4a9eff;font-size:42px;font-weight:700;" x-text="(locale, t('app.title'))"></h1>
                    <p style="color:rgba(255,255,255,0.6);font-size:16px;margin:0;" x-text="(locale, t('projects.selectToBegin'))"></p>
                </div>

                <!-- Project Carousel -->
                <div style="position:relative;width:100%;max-width:800px;">
                    <template x-if="projects.length === 0">
                        <div
                            style="text-align:center;padding:60px 20px;background:rgba(0,0,0,0.3);border-radius:16px;border:2px dashed rgba(255,255,255,0.2);">
                            <div style="font-size:48px;margin-bottom:16px;opacity:0.5;">üìö</div>
                            <p style="color:rgba(255,255,255,0.7);font-size:18px;margin:0 0 24px 0;" x-text="(locale, t('projects.none'))"></p>
                            <button class="btn btn-primary" @click="showNewProjectModal = true"
                                style="padding:12px 24px;font-size:16px;"><span>‚ûï</span> <span x-text="(locale, t('projects.createFirst'))"></span></button>
                        </div>
                    </template>

                    <template x-if="projects.length > 0">
                        <div>
                            <!-- Navigation Arrows -->
                            <template x-if="projects.length > 1">
                                <div>
                                    <button
                                        @click="currentProjectCarouselIndex = (currentProjectCarouselIndex - 1 + projects.length) % projects.length"
                                        class="btn btn-secondary"
                                        style="position:absolute;left:-60px;top:50%;transform:translateY(-50%);padding:12px 16px;font-size:20px;z-index:10;"
                                        :title="(locale, t('nav.prevProject'))">‚Äπ</button>
                                    <button
                                        @click="currentProjectCarouselIndex = (currentProjectCarouselIndex + 1) % projects.length"
                                        class="btn btn-secondary"
                                        style="position:absolute;right:-60px;top:50%;transform:translateY(-50%);padding:12px 16px;font-size:20px;z-index:10;"
                                        :title="(locale, t('nav.nextProject'))">‚Ä∫</button>
                                </div>
                            </template>

                            <!-- Project Card -->
                            <template x-for="(project, index) in projects" :key="project.id">
                                <div x-show="index === currentProjectCarouselIndex"
                                    x-transition:enter="transition ease-out duration-300"
                                    x-transition:enter-start="opacity-0 transform scale-95"
                                    x-transition:enter-end="opacity-100 transform scale-100"
                                    x-data="{ menuOpen: false }"
                                    style="background:rgba(0,0,0,0.4);border:2px solid rgba(74,158,255,0.3);border-radius:16px;padding:40px;position:relative;backdrop-filter:blur(10px);">

                                    <!-- Card Menu Button -->
                                    <div style="position:absolute;top:8px;right:8px;padding:8px;">
                                        <button @click.stop="menuOpen = !menuOpen" class="btn btn-secondary"
                                            style="padding:10px 16px;font-size:20px;min-width:48px;min-height:48px;"
                                            :title="(locale, t('project.options'))">‚ãÆ</button>
                                        <div x-show="menuOpen" x-cloak @click.away="menuOpen = false" x-transition
                                            class="action-menu" style="right:8px;left:auto;min-width:180px;">
                                        <button @click.stop="openProject(project.id); menuOpen=false">üìñ <span x-text="(locale, t('project.card.open'))"></span></button>
                                            <button @click.stop="renameProject(project); menuOpen=false">‚úèÔ∏è <span x-text="(locale, t('project.card.rename'))"></span></button>
                                            <button
                                                @click.stop="document.getElementById('coverInput-' + project.id).click(); menuOpen=false">üñºÔ∏è <span x-text="(locale, t('project.card.changeCover'))"></span></button>
                                            <button x-show="project.coverImage"
                                                @click.stop="removeProjectCover(project.id); menuOpen=false">üóëÔ∏è <span x-text="(locale, t('project.card.removeCover'))"></span></button>
                                            <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                            <button @click.stop="deleteProject(project.id); menuOpen=false"
                                                style="color:#ff6b6b;">üóëÔ∏è <span x-text="(locale, t('project.card.delete'))"></span></button>
                                        </div>
                                    </div>

                                    <!-- Hidden file input for cover upload -->
                                    <input type="file" :id="'coverInput-' + project.id" accept="image/*"
                                        @change="updateProjectCover(project.id, $event.target.files[0]); $event.target.value = null"
                                        style="display:none;">

                                    <!-- Click card to open -->
                                    <div @click="openProject(project.id)" style="cursor:pointer;text-align:center;"
                                        @mouseenter="$el.style.transform = 'scale(1.02)'"
                                        @mouseleave="$el.style.transform = 'scale(1)'"
                                        style="transition:transform 0.2s ease;">

                                        <!-- Cover Image or Fallback -->
                                        <div style="margin-bottom:24px;">
                                            <template x-if="project.coverImage">
                                                <img :src="project.coverImage"
                                                    style="max-width:240px;max-height:360px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.4);"
                                                    :alt="(locale, t('project.card.changeCover'))">
                                            </template>
                                            <template x-if="!project.coverImage">
                                                <div style="font-size:72px;">üìñ</div>
                                            </template>
                                        </div>

                                        <h2 style="margin:0 0 16px 0;color:#fff;font-size:32px;font-weight:700;"
                                            x-text="project.name"></h2>
                                        <p style="color:rgba(255,255,255,0.6);font-size:14px;margin:0;">
                                            <span x-text="(locale, t('project.lastModified')) + ' ' + new Date(project.modified).toLocaleDateString()"></span>
                                        </p>
                                        <p style="color:rgba(255,255,255,0.4);font-size:13px;margin:8px 0 0 0;" x-text="(locale, t('project.clickToOpen'))"></p>
                                    </div>
                                </div>
                            </template>

                            <!-- Project Counter -->
                            <template x-if="projects.length > 1">
                                <div
                                    style="text-align:center;margin-top:24px;color:rgba(255,255,255,0.5);font-size:14px;">
                                    <span x-text="(currentProjectCarouselIndex + 1) + ' / ' + projects.length"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- New Project Button -->
                <div style="margin-top:40px;display:flex;gap:16px;align-items:center;justify-content:center;">
                    <button class="btn btn-primary" @click="showNewProjectModal = true"
                        style="padding:12px 24px;font-size:16px;"><span>‚ûï</span> <span x-text="(locale, t('projects.new'))"></span></button>
                    <button class="btn btn-secondary" @click="showW1ImportModal = true"
                        style="padding:12px 24px;font-size:16px;" :title="(locale, t('projects.importW1.title'))"><span>üì•</span> <span x-text="(locale, t('projects.importW1'))"></span></button>
                </div>
            </div>
        </template>

        <!-- Main App -->
        <template x-if="currentProject && !showModelLoading && !showProjectsView">
            <div class="app-container">
                <!-- Sidebar -->
                <div class="sidebar">
                        <div class="sidebar-header" style="position:relative;">
                        <h1 x-text="(locale, t('app.title'))"></h1>
                        <p x-text="(locale, t('sidebar.subtitle'))"></p>

                        <!-- Main Menu Button -->
                        <div x-data="{ mainMenuOpen: false }" style="position:absolute;top:12px;right:12px;">
                            <button class="btn btn-secondary" @click.stop="mainMenuOpen = !mainMenuOpen"
                                style="padding:6px 12px;font-size:18px;" :title="(locale, t('menu.main'))">‚ò∞</button>
                            <div x-show="mainMenuOpen" x-cloak @click.away="mainMenuOpen = false" x-transition
                                class="action-menu" style="right:0;left:auto;min-width:200px;">
                                <button @click.stop="backToProjects(); mainMenuOpen=false"><span>‚óÑ</span> <span x-text="(locale, t('menu.backToProjects'))"></span></button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="showNewProjectModal = true; mainMenuOpen=false"><span>‚ûï</span> <span x-text="(locale, t('projects.new'))"></span></button>
                                <button @click.stop="document.getElementById('importProjectInput').click(); mainMenuOpen=false"><span>üì•</span> <span x-text="(locale, t('menu.importProject'))"></span></button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="exportProject(); mainMenuOpen=false" :disabled="!currentProject"><span>üì¶</span> <span x-text="(locale, t('menu.exportCurrent'))"></span></button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="openCompendium(); mainMenuOpen=false"><span>üìö</span> <span x-text="(locale, t('menu.compendium'))"></span></button>
                                <button @click.stop="showWorkshopChat = true; mainMenuOpen=false"><span>üí¨</span> <span x-text="(locale, t('menu.workshopChat'))"></span></button>
                                <button @click.stop="showAISettings = true; mainMenuOpen=false"><span>‚öôÔ∏è</span> <span x-text="(locale, t('menu.aiSettings'))"></span></button>
                                <button @click.stop="showPromptsPanel = true; mainMenuOpen=false"><span>üìù</span> <span x-text="(locale, t('menu.managePrompts'))"></span></button>
                                <button @click.stop="openBackupSettings(); mainMenuOpen=false"><span>‚òÅÔ∏è</span> <span x-text="(locale, t('menu.cloudBackup'))"></span></button>
                                <button @click.stop="window.i18n.setLocale('zh-CN'); locale = 'zh-CN'; mainMenuOpen=false">üåê ‰∏≠Êñá</button>
                                <button @click.stop="window.i18n.setLocale('en-US'); locale = 'en-US'; mainMenuOpen=false">üåê <span x-text="(locale, t('lang.english'))"></span></button>
                                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                <button @click.stop="checkForUpdates(); mainMenuOpen=false"
                                    :disabled="checkingForUpdates">
                                    <span x-show="!checkingForUpdates" x-text="(locale, t('menu.checkUpdates'))">üîÑ</span>
                                    <span x-show="checkingForUpdates" x-text="(locale, t('menu.checking'))">‚è≥</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden file input for import (global scope) -->
                    <input type="file" id="importProjectInput" accept=".zip"
                        @change="importProject($event); $event.target.value = null" style="display:none;">

                    <!-- AI Status -->
                    <div class="ai-status">
                        <div class="ai-status-item"
                            style="cursor:pointer;padding:10px 16px;border-radius:8px;transition:background 0.2s;"
                            @click="showAISettings = !showAISettings"
                            @mouseenter="$el.style.background='rgba(74,158,255,0.1)'"
                            @mouseleave="$el.style.background='transparent'" :title="(locale, t('menu.aiSettings'))"
                            :aria-label="(locale, t('menu.aiSettings'))" role="button">
                            <div class="status-dot" :class="aiStatus"></div>
                            <span x-text="aiStatusText"></span>
                            <span style="margin-left:8px;opacity:0.5;font-size:12px;">‚ñº</span>
                        </div>

                        <!-- Backup Status -->
                        <div x-show="backupEnabled" class="ai-status-item"
                            style="cursor:pointer;padding:8px 16px;border-radius:8px;transition:background 0.2s;font-size:12px;"
                            @click="openBackupSettings()" @mouseenter="$el.style.background='rgba(76,175,80,0.1)'"
                            @mouseleave="$el.style.background='transparent'" :title="(locale, t('menu.cloudBackup'))">
                            <span>‚òÅÔ∏è</span>
                            <span x-text="backupStatus || (locale, t('backup.autoEnabled'))"></span>
                        </div>
                    </div>

                    <div class="project-info" x-data="{ openMenu:false }"
                        style="position:relative;padding:16px 12px;border-bottom:2px solid rgba(74,158,255,0.3);">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <h2 style="margin:0;padding-right:8px;">
                                <button class="project-name-button" @click.stop="openCompendium()"
                                    :title="(locale, t('menu.compendium'))" aria-controls="compendium-panel"
                                    :aria-expanded="showCodexPanel ? 'true' : 'false'"
                                    style="background:none;border:none;padding:8px 12px 8px 0;font-size:18px;font-weight:700;color:#4a9eff;cursor:pointer;border-radius:6px;transition:all 0.2s;"
                                    @mouseenter="$el.style.background='rgba(74,158,255,0.15)'"
                                    @mouseleave="$el.style.background='transparent'">
                                    <span x-text="currentProject.name"></span>
                                    <span style="margin-left:8px;opacity:0.7;font-size:16px;">üìö</span>
                                </button>
                            </h2>

                            <div style="display:flex;align-items:center;gap:6px;">
                                <button class="menu-button" @click.stop="openMenu = !openMenu"
                                    :title="(locale, t('project.options'))">‚ãØ</button>
                                <div x-show="openMenu" x-cloak @click.away="openMenu = false" x-transition
                                    class="action-menu">
                                    <button
                                        @click.stop="showRenameProjectModal = true; renameProjectName = currentProject.name; openMenu=false" x-text="(locale, t('common.rename'))"></button>
                                    <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                    <div style="max-height:200px;overflow:auto;margin-bottom:6px;">
                                        <strong style="display:block;padding:6px 10px;color:var(--text-secondary);font-size:12px;" x-text="(locale, t('project.switch'))"></strong>
                                        <template x-for="p in projects" :key="p.id">
                                            <button @click.stop="selectProject(p.id); openMenu=false"
                                                style="padding-left:10px;">
                                                <span x-text="p.name"></span>
                                            </button>
                                        </template>
                                    </div>
                                    <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                                    <button @click.stop="exportProject(); openMenu=false"><span>üì¶</span> <span x-text="(locale, t('menu.exportCurrent'))"></span></button>
                                    <div style="margin-top:6px"></div>
                                    <button @click.stop="showNewProjectModal = true; openMenu=false"><span>‚ûï</span> <span x-text="(locale, t('projects.new'))"></span></button>
                                </div>
                            </div>
                        </div>

                        <div class="word-count" x-text="(locale, `${totalWords} ` + t('common.words'))" style="margin-top:6px;"></div>
                    </div>

                    <div class="scene-list">
                        <template x-for="chapter in chapters" :key="chapter.id">
                            <div class="chapter-item">
                                <div class="chapter-header" style="align-items:center;gap:8px;"
                                    x-data="{ openMenu:false }">
                                    <div
                                        style="flex:1;display:flex;justify-content:space-between;align-items:center;position:relative;">
                                        <div style="flex:1;display:flex;align-items:center;gap:8px;">
                                            <span class="summary-dot"
                                                :class="{ 'has': chapter.summary && !chapter.summaryStale, 'stale': chapter.summaryStale, 'none': !chapter.summary }"
                                                :title="`${chapter.title}: ${chapter.summary ? (chapter.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"
                                                :aria-label="`${chapter.title}: ${chapter.summary ? (chapter.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"></span>
                                            <div style="flex:1;" x-text="chapter.title"></div>
                                            <div
                                                style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;">
                                                <span x-text="`${chapter.scenes ? chapter.scenes.length : 0}`"></span>
                                            </div>
                                        </div>

                                        <div class="item-actions" style="margin-left:8px;">
                                            <button class="menu-button" @click.stop="openMenu = !openMenu" :title="(locale, t('common.more'))">
                                                ‚ãØ
                                            </button>

                                            <div x-show="openMenu" x-cloak @click.away="openMenu = false" x-transition
                                                class="action-menu">
                                                <button
                                                    @click.stop="chapter.expanded = !chapter.expanded; openMenu=false"
                                                    x-text="(locale, chapter.expanded ? t('common.collapse') : t('common.expand'))"></button>
                                                <button
                                                    @click.stop="openRenameChapterModal(chapter.id); openMenu=false" x-text="(locale, t('modal.renameChapter.title'))"></button>
                                                <button
                                                    @click.stop="openChapterSummary(chapter.id); openMenu=false" x-text="(locale, t('summary.chapter'))"></button>
                                                <button @click.stop="moveChapterUp(chapter.id); openMenu=false" x-text="(locale, t('common.moveUp'))"></button>
                                                <button @click.stop="moveChapterDown(chapter.id); openMenu=false" x-text="(locale, t('common.moveDown'))"></button>
                                                <button @click.stop="deleteChapter(chapter.id); openMenu=false" x-text="(locale, t('project.card.delete'))"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="chapter-scenes" x-show="chapter.expanded">
                                    <template x-for="scene in chapter.scenes" :key="scene.id">
                                        <div class="scene-item"
                                            :class="{ 'active': currentScene && currentScene.id === scene.id }"
                                            @click="loadScene(scene.id)"
                                            :title="`${scene.title}${scene.povCharacter ? ' (' + t('pov.label') + ': ' + scene.povCharacter + ')' : ''}\n${scene.summary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"
                                            :aria-label="`${scene.title}: ${scene.summary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"
                                            style="display:flex;justify-content:space-between;align-items:center;">
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="summary-dot"
                                                    :class="{ 'has': scene.summary && !scene.summaryStale, 'stale': scene.summaryStale, 'none': !scene.summary }"
                                                    :title="`${scene.title}: ${scene.summary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"
                                                    :aria-label="`${scene.title}: ${scene.summary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')}`"></span>
                                                <div>
                                                    <div class="scene-title" x-text="scene.title"></div>
                                                    <div class="scene-meta" x-text="(locale, `${scene.wordCount || 0} ` + t('common.words'))">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="item-actions" style="margin-left:12px;"
                                                x-data="{ openMenu:false }">

                                                <!-- Backdrop overlay -->
                                                <div x-show="openMenu" x-cloak @click="openMenu = false"
                                                    style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:9998;"
                                                    x-transition:enter="transition ease-out duration-200"
                                                    x-transition:enter-start="opacity-0"
                                                    x-transition:enter-end="opacity-100"
                                                    x-transition:leave="transition ease-in duration-150"
                                                    x-transition:leave-start="opacity-100"
                                                    x-transition:leave-end="opacity-0">
                                                </div>

                                                <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                    :title="(locale, t('common.more'))">
                                                    ‚ãØ
                                                </button>

                                                <div x-show="openMenu" x-cloak @mouseenter.stop @mousemove.stop
                                                    x-transition class="action-menu" @click.stop x-ref="actionMenu">
                                                    <div
                                                        style="font-size:13px;color:var(--text-secondary);padding:4px 0 8px 0;border-bottom:1px solid var(--border);margin-bottom:8px;">
                                                        <span x-text="(locale, t('common.moveToLabel'))"></span>
                                                    </div>
                                                    <template x-for="ch in chapters" :key="ch.id">
                                                        <button
                                                            @click.stop="moveSceneToChapter(scene.id, ch.id); openMenu=false"
                                                            :style="ch.id === scene.chapterId ? 'background: var(--bg-tertiary);' : ''"
                                                            x-text="ch.title">
                                                        </button>
                                                    </template>
                                                    <div
                                                        style="border-top:1px solid var(--border);margin-top:8px;padding-top:8px;">
                                                    </div>

                                                    <button @click.stop="moveSceneUp(scene.id); openMenu=false" x-text="(locale, t('common.moveUp'))"></button>
                                                    <button @click.stop="moveSceneDown(scene.id); openMenu=false" x-text="(locale, t('common.moveDown'))"></button>
                                                    <button
                                                        @click.stop="openRenameSceneModal(scene.id); openMenu=false" x-text="(locale, t('modal.renameScene.title'))"></button>
                                                    <button
                                                        @click.stop="openSceneSummary(scene.id); openMenu=false" x-text="(locale, t('summary.scene'))"></button>
                                                    <button @click.stop="deleteScene(scene.id); openMenu=false" x-text="(locale, t('project.card.delete'))"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="sidebar-actions"
                        style="display:flex;flex-direction:row;padding:10px;gap:8px;align-items:center;">
                        <button class="add-scene-btn" @click="openNewChapterModal()" :aria-label="(locale, t('modal.newChapter.title'))"
                            :title="(locale, t('modal.newChapter.title'))">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path d="M3 7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"
                                    fill="currentColor" />
                            </svg>
                        </button>

                        <button class="add-scene-btn" @click="openNewSceneModal()" :aria-label="(locale, t('modal.newScene.title'))"
                            :title="(locale, t('modal.newScene.title'))">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path
                                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM14 3.5L18.5 8H15a1 1 0 0 1-1-1V3.5z"
                                    fill="currentColor" />
                                <path d="M8 12h8v2H8v-2zm0 4h5v2H8v-2z" fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Editor -->
                <div class="editor-container" x-data="{ beatSplitterDragging: false }"
                    @mouseup.window="beatSplitterDragging = false" @mousemove.window="if (beatSplitterDragging) {
                        const container = $el;
                        const rect = container.getBoundingClientRect();
                        const y = $event.clientY - rect.top;
                        const newHeight = rect.height - y;
                        beatPanelHeight = Math.max(150, Math.min(600, newHeight));
                    }">
                    <div class="editor-header">
                        <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                            <div class="editor-title" x-text="currentScene ? currentScene.title : t('tts.noSceneSelected')">
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <button class="btn btn-secondary"
                                    @click="showEmbeddedWorkshop = !showEmbeddedWorkshop; if (showEmbeddedWorkshop && (!workshopSessions || workshopSessions.length === 0)) { workshopSessions = [window.workshopChat.createNewSession($data)]; saveWorkshopSessions(); }"
                                    :style="showEmbeddedWorkshop ? 'background: rgba(76,175,80,0.2); border-color: rgba(76,175,80,0.5);' : ''"
                                    :title="(locale, t('menu.workshopChat'))">
                                    üí¨
                                </button>
                                <div class="editor-stats" style="white-space:nowrap;">
                                    <span x-text="(locale, `${currentSceneWords} ` + t('common.words'))"></span>
                                    <span class="save-indicator" :class="{ 'saving': isSaving }"
                                        x-text="saveStatus"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formatting Toolbar (compact dropdown) -->
                    <div x-show="currentScene" x-cloak x-data="{ formatMenuOpen: false }"
                        style="padding:8px 30px;background:var(--bg-secondary);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;">
                        <span style="font-size:12px;color:var(--text-secondary);" x-text="(locale, t('format.title'))"></span>
                        <button @click="formatMenuOpen = !formatMenuOpen" class="btn btn-secondary"
                            style="position:relative;">
                            ‚úé <span x-text="(locale, t('format.textFormatting'))"></span>
                        </button>

                        <!-- Preview Toggle Button -->
                        <button @click="showMarkdownPreview = !showMarkdownPreview" class="btn btn-secondary"
                            :class="{ 'btn-primary': showMarkdownPreview }"
                            :title="(locale, showMarkdownPreview ? t('common.more') : t('gen.generateTextTitle'))">
                            <span x-show="!showMarkdownPreview">üëÅÔ∏è <span x-text="(locale, t('editor.preview'))"></span></span>
                            <span x-show="showMarkdownPreview">‚úèÔ∏è <span x-text="(locale, t('editor.edit'))"></span></span>
                        </button>

                        <!-- Rewrite Selection Button (only visible when text is selected) -->
                        <button x-show="showRewriteBtn && !showMarkdownPreview" @click="handleRewriteButtonClick()"
                            class="btn btn-secondary" :title="(locale, t('rewrite.title'))">
                            ‚ú® <span x-text="(locale, t('rewrite.title'))"></span>
                        </button>

                        <!-- TTS Read Aloud Button (only in preview mode) -->
                        <button x-show="showMarkdownPreview" @click="toggleTTS()" class="btn btn-secondary"
                            :class="{ 'btn-primary': isReading }"
                            :title="(locale, isReading ? t('tts.notAvailable') : t('tts.readingSpeed'))">
                            <span x-show="!isReading">üîä <span x-text="(locale, t('tts.readAloud'))"></span></span>
                            <span x-show="isReading">‚è∏Ô∏è <span x-text="(locale, t('tts.stop'))"></span></span>
                        </button>
                        <div x-show="formatMenuOpen" @click.away="formatMenuOpen = false" x-cloak
                            style="position:absolute;top:45px;left:80px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;display:grid;grid-template-columns:1fr 1fr;gap:4px;min-width:280px;">
                            <button @click="applyFormatting('bold'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;font-weight:bold;" :title="(locale, t('format.boldTip'))">
                                <span style="width:20px;display:inline-block;">B</span> <span x-text="(locale, t('format.boldLabel'))"></span>
                            </button>
                            <button @click="applyFormatting('italic'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;font-style:italic;"
                                :title="(locale, t('format.italicTip'))">
                                <span style="width:20px;display:inline-block;">I</span> <span x-text="(locale, t('format.italicLabel'))"></span>
                            </button>
                            <button @click="applyFormatting('strikethrough'); formatMenuOpen=false"
                                class="btn btn-secondary"
                                style="justify-content:flex-start;text-decoration:line-through;"
                                :title="(locale, t('format.strikeTip'))">
                                <span style="width:20px;display:inline-block;">S</span> <span x-text="(locale, t('format.strikeLabel'))"></span>
                            </button>
                            <button @click="applyFormatting('heading'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;" :title="(locale, t('format.headingTip'))">
                                <span style="width:20px;display:inline-block;">H</span> <span x-text="(locale, t('format.headingLabel'))"></span>
                            </button>
                            <button @click="applyFormatting('quote'); formatMenuOpen=false" class="btn btn-secondary"
                                style="justify-content:flex-start;" :title="(locale, t('format.quoteTip'))">
                                <span style="width:20px;display:inline-block;">"</span> <span x-text="(locale, t('format.quoteLabel'))"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Editor/Workshop Split Container -->
                    <div class="editor-workshop-split" x-data="{ isDragging: false }"
                        @mouseup.window="isDragging = false" @mousemove.window="if (isDragging) { 
                            const container = $el;
                            const rect = container.getBoundingClientRect();
                            const x = $event.clientX - rect.left;
                            workshopSplitterPosition = Math.max(30, Math.min(70, (x / rect.width) * 100));
                        }">

                        <!-- Editor Content -->
                        <div class="editor-workshop-content"
                            :style="showEmbeddedWorkshop ? `width: ${workshopSplitterPosition}%` : 'width: 100%'">
                            <div class="editor-main" style="height: 100%;">
                                <!-- Export Reminder Banner -->
                                <template x-if="showExportReminder && !exportReminderDismissed">
                                    <div
                                        style="background:linear-gradient(135deg, rgba(255,193,7,0.15), rgba(255,152,0,0.1));border-bottom:2px solid rgba(255,193,7,0.4);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;">
                                        <div style="display:flex;align-items:center;gap:12px;flex:1;">
                                            <span style="font-size:24px;">üíæ</span>
                                            <div>
                                                <div
                                                    style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">
                                                    <span x-text="(locale, t('export.reminder.title'))"></span>
                                                </div>
                                                <div
                                                    style="font-size:12px;color:var(--text-secondary);line-height:1.4;">
                                                    <span x-text="(locale, t('export.reminder.body'))"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display:flex;gap:8px;align-items:center;">
                                            <button class="btn btn-primary" @click="exportProject()"
                                                style="padding:8px 16px;font-size:13px;white-space:nowrap;">
                                                <span x-text="(locale, t('export.reminder.exportNow'))"></span>
                                            </button>
                                            <button class="btn btn-secondary" @click="dismissExportReminder()"
                                                style="padding:8px 12px;font-size:13px;">
                                                <span x-text="(locale, t('export.reminder.dismiss'))"></span>
                                            </button>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="currentScene">
                                    <div style="position:relative;height:100%;display:flex;flex-direction:column;">
                                        <!-- Edit Mode: Textarea -->
                                        <textarea x-show="!showMarkdownPreview" class="editor-textarea"
                                                :class="{ 'has-generated-text': showGeneratedHighlight }"
                                                @input="onEditorChange($event); handleAutoReplace($event)"
                                                @paste="handlePaste" :value="currentScene ? currentScene.content : ''"
                                                style="outline:none;direction:ltr;resize:none;" dir="ltr"
                                                :placeholder="(locale, t('place.scene.writeHere'))"></textarea>

                                        <!-- Preview Mode: Rendered HTML -->
                                        <div x-show="showMarkdownPreview" class="editor-preview"
                                            x-html="currentScene ? markdownToHtml(currentScene.content) : ''"
                                            style="flex:1;padding:50px 60px;background:var(--bg-primary);overflow-y:auto;direction:ltr;font-family:'Georgia',serif;font-size:17px;line-height:2.0;color:#e8e8e8;">
                                        </div>
                                    </div>
                                </template> <template x-if="!currentScene">
                                    <div class="welcome-screen">
                                        <div class="welcome-content">
                                            <h2 x-text="(locale, t('welcome.title'))"></h2>
                                            <p x-text="(locale, t('welcome.message'))"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Splitter -->
                        <div x-show="showEmbeddedWorkshop" class="workshop-splitter" @mousedown="isDragging = true">
                        </div>

                        <!-- Embedded Workshop Panel -->
                        <div x-show="showEmbeddedWorkshop"
                            x-init="(async () => { await loadWorkshopSessions(); if (!workshopSessions || workshopSessions.length === 0) { workshopSessions = [window.workshopChat.createNewSession($data)]; await saveWorkshopSessions(); } })()"
                            class="embedded-workshop-panel" :style="`width: ${100 - workshopSplitterPosition}%`">

                            <!-- Workshop Header -->
                            <div class="embedded-workshop-header">
                                <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
                                    <span style="font-size:14px;font-weight:600;white-space:nowrap;" x-text="(locale, t('workshop.title'))"></span>
                                    <select x-model="currentWorkshopSessionIndex" class="workshop-select"
                                        style="flex:1;min-width:0;font-size:12px;">
                                        <template x-for="(session, idx) in workshopSessions" :key="session.id">
                                            <option :value="idx" x-text="session.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <button class="btn btn-secondary btn-sm" @click="createWorkshopSession"
                                    :title="(locale, t('workshop.newChatTitle'))">+</button>
                            </div>

                            <!-- Workshop Messages -->
                            <div class="embedded-workshop-messages">
                                <template
                                    x-if="workshopSessions[currentWorkshopSessionIndex] && workshopSessions[currentWorkshopSessionIndex].messages.length === 0">
                                    <div
                                        style="text-align:center;color:var(--text-secondary);font-size:13px;padding:20px;">
                                        Start a conversation with the AI to brainstorm ideas...
                                    </div>
                                </template>
                                <template x-if="workshopSessions[currentWorkshopSessionIndex]">
                                    <template
                                        x-for="(msg, idx) in workshopSessions[currentWorkshopSessionIndex].messages"
                                        :key="idx">
                                        <div class="workshop-message" :class="`workshop-message-${msg.role}`">
                                            <div class="workshop-message-content"
                                                x-html="markdownToHtml(msg.content || '')"></div>
                                        </div>
                                    </template>
                                </template>
                            </div>

                            <!-- Workshop Input -->
                            <div class="embedded-workshop-input-area">
                                <textarea class="embedded-workshop-textarea workshop-textarea" x-model="workshopInput"
                                    @input="window.workshopChat.onWorkshopInput($data, $event)"
                                    @keydown="window.workshopChat.handleWorkshopKeydown($data, $event); if ($event.key === 'Enter' && !$event.shiftKey) { $event.preventDefault(); window.workshopChat.sendMessage($data, workshopInput); }"
                                    :placeholder="(locale, t('place.workshop.inputAlt'))"
                                    :disabled="workshopIsGenerating"></textarea>
                                <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                                    <button class="btn btn-secondary btn-sm"
                                        @click="useWorkshopContextPanel = !useWorkshopContextPanel"
                                        :style="useWorkshopContextPanel ? 'background: rgba(76,175,80,0.2); border-color: rgba(76,175,80,0.5);' : ''"
                                        :title="(locale, t('workshop.useContextTitle'))">
                                        üìö
                                    </button>
                                    <button class="btn btn-primary btn-sm"
                                        @click="window.workshopChat.sendMessage($data, workshopInput)"
                                        :disabled="!workshopInput.trim() || workshopIsGenerating" style="flex:1;">
                                        <span x-show="!workshopIsGenerating" x-text="(locale, t('workshop.send'))"></span>
                                        <span x-show="workshopIsGenerating">...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Beat Panel -->
                    <div class="beat-separator" aria-hidden="true"
                        @mousedown="beatSplitterDragging = true; $event.preventDefault();"></div>
                    <div class="beat-panel"
                        :style="`height: ${beatPanelHeight}px; min-height: ${beatPanelHeight}px; max-height: ${beatPanelHeight}px;`">
                        <h3 x-text="(locale, t('beat.generateFrom'))"></h3>
                        <div class="beat-input-group" style="position:relative;">
                            <textarea class="beat-input" x-model="beatInput" @input="onBeatInput($event)"
                                @keydown="onBeatKey($event)"
                                :placeholder="(locale, t('place.scene.describeNext'))"
                                spellcheck="true" rows="2"></textarea>

                            <div class="quick-search-dropdown" x-show="showQuickSearch" x-cloak
                                style="position:relative;width:100%;">
                                <div
                                    style="position:absolute;bottom:100%;left:0;right:0;z-index:5000;background:var(--bg-primary);border:1px solid var(--accent);border-radius:6px;padding:6px;max-height:240px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.4);margin-bottom:8px;">
                                    <template x-for="(m,mi) in quickSearchMatches" :key="m.id">
                                        <div class="quick-search-item"
                                            :class="{ 'active': mi === quickSearchSelectedIndex }"
                                            @click="selectQuickMatch(m)"
                                            style="padding:6px;border-radius:4px;cursor:pointer;">
                                            <div style="font-weight:600" x-text="m.title"></div>
                                            <div style="font-size:12px;color:var(--text-secondary);"
                                                x-text="(m.category || '')"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="scene-search-dropdown" x-show="showSceneSearch" x-cloak
                                style="position:relative;width:100%;">
                                <div
                                    style="position:absolute;bottom:100%;left:0;right:0;z-index:5000;background:var(--bg-primary);border:1px solid var(--accent-blue,#60a5fa);border-radius:6px;padding:6px;max-height:240px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.4);margin-bottom:8px;">
                                    <template x-for="(scene,si) in sceneSearchMatches" :key="scene.id">
                                        <div class="scene-search-item"
                                            :class="{ 'active': si === sceneSearchSelectedIndex }"
                                            @click="selectSceneMatch(scene)"
                                            style="padding:6px;border-radius:4px;cursor:pointer;">
                                            <div style="display:flex;align-items:center;gap:6px;">
                                                <span
                                                    x-text="scene.hasSummary ? (scene.summaryStale ? '‚ö†Ô∏è' : '‚úÖ') : '‚ùå'"
                                                    :title="scene.hasSummary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')"></span>
                                                <span style="font-weight:600" x-text="scene.title"></span>
                                            </div>
                                            <div style="font-size:12px;color:var(--text-secondary);"
                                                x-text="scene.chapterName || t('chapter.unknown')"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <div class="beat-controls"
                            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:0;">
                            <div class="beat-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                                <div style="position:relative;">
                                    <button class="btn btn-secondary" @click="showSpecialChars = !showSpecialChars"
                                        :title="(locale, t('special.insert'))"
                                        :disabled="!currentScene || showMarkdownPreview"
                                        style="font-size:14px;padding:6px 12px;">
                                        ‚åò
                                    </button>
                                    <div x-show="showSpecialChars" @click.outside="showSpecialChars = false" x-cloak
                                        style="position:absolute;left:0;bottom:100%;margin-bottom:4px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;min-width:280px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                                        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;font-weight:600;"
                                            x-text="(locale, t('special.insertTitle'))"></div>
                                        <button @click="insertSpecialChar('‚Äî')" class="special-char-btn" x-text="(locale, t('special.emDash'))"></button>
                                        <button @click="insertSpecialChar('‚Äì')" class="special-char-btn" x-text="(locale, t('special.enDash'))"></button>
                                        <button @click="insertSpecialChar('\u00A0')" class="special-char-btn" x-text="(locale, t('special.nbsp'))"></button>
                                        <button @click="insertSpecialChar('¬´')" class="special-char-btn" x-text="(locale, t('special.frenchQuoteLeft'))"></button>
                                        <button @click="insertSpecialChar('¬ª')" class="special-char-btn" x-text="(locale, t('special.frenchQuoteRight'))"></button>
                                        <button @click="insertSpecialChar('‚Äû')" class="special-char-btn" x-text="(locale, t('special.lowHighQuote'))"></button>
                                        <button @click="insertSpecialChar('&quot;')" class="special-char-btn" x-text="(locale, t('special.lowHighDouble'))"></button>
                                        <button @click="insertSpecialChar('\u0027')" class="special-char-btn" x-text="(locale, t('special.singleQuote'))"></button>
                                        <button @click="insertSpecialChar('\u0027')" class="special-char-btn" x-text="(locale, t('special.singleQuote'))"></button>
                                        <button @click="insertSpecialChar(')')" class="special-char-btn" x-text="(locale, t('special.parenRight'))"></button>
                                        <button @click="insertSpecialChar('‚Ä¶')" class="special-char-btn" x-text="(locale, t('special.ellipsis'))"></button>
                                        <button @click="insertSpecialChar('\u2003')" class="special-char-btn" x-text="(locale, t('special.emSpace'))"></button>
                                        <button @click="insertSpecialChar('\u2002')" class="special-char-btn" x-text="(locale, t('special.enSpace'))"></button>
                                        <button @click="insertSpecialChar('\u2009')" class="special-char-btn" x-text="(locale, t('special.thinSpace'))"></button>
                                        <div
                                            style="font-size:10px;color:var(--text-secondary);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
                                            Tip: Type -- for em dash (‚Äî)</div>
                                    </div>
                                </div>

                                <button class="btn btn-secondary" @click="loadPromptHistory(); showPromptHistory = true"
                                    :title="(locale, t('promptHistory.view'))" :aria-label="(locale, t('promptHistory.aria'))">
                                    üïê
                                </button>

                                <button class="btn btn-secondary" @click="showSceneOptions = !showSceneOptions"
                                    :title="(locale, t('scene.options.title'))">
                                    ‚öôÔ∏è
                                </button>

                                <button class="btn btn-secondary" @click="showContextPanel = !showContextPanel"
                                    :title="(locale, t('context.panel.title'))" :aria-label="(locale, t('context.panel.title'))">
                                    üìö
                                </button>

                                <button class="btn btn-secondary" @click="previewPrompt"
                                    :disabled="!beatInput || aiStatus !== 'ready'" :title="(locale, t('promptHistory.view'))">
                                    üëÅÔ∏è
                                </button>

                                <button class="btn btn-secondary" @click="generateFromBeat"
                                    :disabled="!beatInput || isGenerating || aiStatus !== 'ready'"
                                    :title="(locale, t('gen.generateTextTitle'))">
                                    ‚ú®
                                </button>
                            </div>

                            <div class="context-info">
                                <span x-show="aiStatus === 'ready'" x-text="(locale, t('ai.readyInline'))"></span>
                                <span x-show="aiStatus === 'loading'" x-text="(locale, t('ai.loadingModel'))"></span>
                                <span x-show="aiStatus === 'error'" x-text="(locale, t('ai.modelNotLoaded'))"></span>
                            </div>

                            <!-- Generation actions (accept/retry/discard) -->
                            <div x-show="showGenActions" x-cloak style="display:flex;gap:8px;justify-content:flex-end;">
                                <button class="btn btn-primary" @click="acceptGeneration" x-text="(locale, t('common.accept'))"></button>
                                <button class="btn btn-secondary" @click="retryGeneration" x-text="(locale, t('common.retry'))"></button>
                                <button class="btn btn-secondary" @click="discardGeneration" x-text="(locale, t('common.discard'))"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Rewrite Modal -->
        <div x-show="showRewriteModal" x-cloak class="modal-overlay" @click.self="discardRewrite()">
            <div class="rewrite-modal" @click.stop>
                <div class="modal-header">
                    <h3 style="margin:0;" x-text="(locale, t('rewrite.title'))"></h3>
                    <button class="btn btn-secondary" @click="discardRewrite()" x-text="(locale, t('common.close'))"></button>
                </div>

                <div class="modal-body">
                    <label style="font-size:12px;color:var(--text-secondary);"><span x-text="(locale, t('pov.character.label'))"></span>
                        <input type="text" x-model="povCharacter" :placeholder="(locale, t('place.scene.pov'))" list="character-list"
                            @blur="saveScene()" @keydown.enter.prevent="saveScene()"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                        <datalist id="character-list">
                            <template x-for="char in compendiumList.filter(c => c.category === 'characters')"
                                :key="char.id">
                                <option :value="char.title"></option>
                            </template>
                        </datalist>
                    </label>

                    <label style="font-size:12px;color:var(--text-secondary);">
                        <span x-text="(locale, t('pov.label'))"></span>
                        <select x-model="pov" @change="saveScene()"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <option value="3rd person limited" x-text="(locale, t('pov.option.3rdLimited'))"></option>
                            <option value="1st person" x-text="(locale, t('pov.option.1stPerson'))"></option>
                            <option value="omniscient" x-text="(locale, t('pov.option.omniscient'))"></option>
                        </select>
                    </label>

                    <label style="font-size:12px;color:var(--text-secondary);">
                        <span x-text="(locale, t('tense.label'))"></span>
                        <select x-model="tense" @change="saveScene()"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <option value="past" x-text="(locale, t('tense.option.past'))"></option>
                            <option value="present" x-text="(locale, t('tense.option.present'))"></option
                        ></select>
                    </label>

                    <label style="font-size:12px;color:var(--text-secondary);">
                        <span x-text="(locale, t('prose.promptLabel'))"></span>
                        <select x-model="selectedProsePromptId" @change="saveSelectedProsePrompt(selectedProsePromptId)"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <option value="" x-text="(locale, t('prose.useCurrentPromptFallback'))"></option
                        >
                        <template x-for="pr in prompts.filter(p => p.category === 'prose')" :key="pr.id">
                            <option :value="pr.id" x-text="pr.title"></option>
                        </template>
                        </select>
                    </label>

                    <!-- Generation Settings -->
                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                        <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:12px;" x-text="(locale, t('gen.settings.title'))"></div>

                        <!-- Model Selection -->
                        <label style="font-size:12px;color:var(--text-secondary);"
                            :title="(locale, t('gen.model.help'))">
                            <span x-text="(locale, t('gen.model.label'))"></span>
                            <select x-model="aiModel" @change="saveGenerationParams()"
                                style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                <!-- API mode models -->
                                <template x-for="model in (aiMode === 'api' ? (providerModels[aiProvider] || []) : [])"
                                    :key="model.id">
                                    <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                    </option>
                                </template>
                                <!-- Local mode models -->
                                <template x-for="modelName in (aiMode === 'local' ? availableLocalModels : [])"
                                    :key="modelName">
                                    <option :value="modelName" x-text="modelName"></option>
                                </template>
                                <!-- Show current model if not in lists -->
                                <option
                                    x-show="aiModel && ((aiMode === 'api' && !(providerModels[aiProvider] || []).find(m => m.id === aiModel)) || (aiMode === 'local' && !availableLocalModels.includes(aiModel)))"
                                    :value="aiModel" x-text="aiModel"></option>
                                <!-- Fallback for local mode with no models -->
                                <option x-show="aiMode === 'local' && availableLocalModels.length === 0 && !aiModel"
                                    value="" disabled x-text="(locale, t('ai.localModel.placeholder'))"></option>
                            </select>
                        </label>

                        <!-- Temperature -->
                        <label style="font-size:12px;color:var(--text-secondary);margin-top:12px;display:block;"
                            :title="(locale, t('gen.temperature.help'))">
                            <span x-text="(locale, t('gen.temperature.label'))"></span>: <span x-text="temperature.toFixed(1)"></span>
                            <input type="range" x-model.number="temperature" min="0.1" max="1.5" step="0.1"
                                @input="saveGenerationParams()" style="width:100%;margin-top:6px;">
                            <div
                                style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                <span x-text="(locale, t('gen.modes.focused'))"></span>
                                <span x-text="(locale, t('gen.modes.balanced'))"></span>
                                <span x-text="(locale, t('gen.modes.creative'))"></span>
                            </div>
                        </label>

                        <!-- Max Tokens -->
                        <label style="font-size:12px;color:var(--text-secondary);margin-top:12px;display:block;"
                            :title="(locale, t('gen.maxLength.help'))">
                            <span x-text="(locale, t('gen.maxLength'))"></span>: <span x-text="maxTokens"></span> <span x-text="(locale, t('gen.tokens'))"></span>
                            <input type="range" x-model.number="maxTokens" min="100" max="20000" step="100"
                                @input="saveGenerationParams()" style="width:100%;margin-top:6px;">
                            <div
                                style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                <span x-text="(locale, t('gen.length.short'))"></span>
                                <span x-text="(locale, t('gen.length.medium'))"></span>
                                <span x-text="(locale, t('gen.length.veryLong'))"></span>
                            </div>
                        </label>

                        <!-- Quick link to full AI Settings -->
                        <button class="btn btn-secondary" @click="showSceneOptions = false; showAISettings = true"
                            style="width:100%;margin-top:12px;font-size:11px;">
                            ‚öôÔ∏è <span x-text="(locale, t('gen.advancedSettings'))"></span>
                        </button>
                    </div>
                </div>
            </div>
            x-init="$watch('showContextPanel', async (value) => { if (value) { allCompendiumEntries = await
            getAllCompendiumEntries(); } })"
            style="background:var(--bg-tertiary);padding:16px;border-radius:6px;border:1px solid
            var(--border);width:900px;max-width:95vw;max-height:600px;overflow-y:auto;">
            <div style="display:flex;flex-direction:column;gap:12px;">
                <div>
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:4px;" x-text="(locale, t('context.sceneSettingsTitle'))"></div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;" x-text="(locale, t('context.sceneSettingsDesc'))"></div>
                </div>

                <!-- Two Column Layout -->
                <div style="display:flex;gap:16px;align-items:flex-start;">
                    <!-- Left Column: Compendium -->
                    <div style="flex:0 0 350px;display:flex;flex-direction:column;gap:12px;">
                        <!-- Compendium Entries Section -->
                        <div
                            style="background:var(--bg-secondary);padding:12px;border-radius:6px;border:1px solid var(--border);display:flex;flex-direction:column;height:100%;">
                            <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">
                                üìö <span x-text="(locale, t('compendium.title'))"></span>
                            </div>
                            <div style="flex:1;overflow-y:auto;">
                                <template x-if="allCompendiumEntries.length === 0">
                                    <div
                                        style="font-size:12px;color:var(--text-tertiary);padding:8px;text-align:center;"
                                        x-text="(locale, t('compendium.noEntries'))"></div>
                                </template>
                                <template x-for="category in compendiumCategories" :key="category">
                                    <div x-show="allCompendiumEntries.filter(e => e.category === category).length > 0"
                                        style="margin-bottom:12px;">
                                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;font-weight:600;"
                                            x-text="category"></div>
                                        <template
                                            x-for="entry in allCompendiumEntries.filter(e => e.category === category)"
                                            :key="entry.id">
                                            <label
                                                style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;border-radius:4px;font-size:13px;"
                                                @mouseenter="$el.style.background = 'var(--bg-tertiary)'"
                                                @mouseleave="$el.style.background = 'transparent'">
                                                <input type="checkbox"
                                                    :checked="contextPanel.compendiumIds.includes(entry.id)"
                                                    @change="toggleContextCompendium(entry.id)" style="cursor:pointer;">
                                                <span x-text="entry.title"></span>
                                            </label>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Scenes & Tags -->
                    <div style="flex:1;display:flex;flex-direction:column;gap:12px;">
                        <!-- Scenes Section -->
                        <div
                            style="background:var(--bg-secondary);padding:12px;border-radius:6px;border:1px solid var(--border);">
                            <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">
                                üìÑ Scenes
                            </div>
                            <div style="max-height:300px;overflow-y:auto;">
                                <template x-if="chapters.length === 0">
                                    <div
                                        style="font-size:12px;color:var(--text-tertiary);padding:8px;text-align:center;">
                                        No scenes yet
                                    </div>
                                </template>
                                <template x-for="chapter in chapters" :key="chapter.id">
                                    <div style="margin-bottom:16px;">
                                        <!-- Chapter Header -->
                                        <div
                                            style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:6px;background:var(--bg-tertiary);border-radius:4px;">
                                            <div style="font-size:13px;font-weight:600;" x-text="chapter.title">
                                            </div>
                                            <div style="display:flex;gap:8px;">
                                                <button
                                                    @click="setContextChapter(chapter.id, contextPanel.chapters[chapter.id] === 'full' ? null : 'full')"
                                                    :style="contextPanel.chapters[chapter.id] === 'full' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                    class="context-chapter-btn"
                                                    :title="(locale, t('context.includeFullAll'))">
                                                    üìÑ <span x-text="(locale, t('context.fullText'))"></span>
                                                </button>
                                                <button
                                                    @click="setContextChapter(chapter.id, contextPanel.chapters[chapter.id] === 'summary' ? null : 'summary')"
                                                    :style="contextPanel.chapters[chapter.id] === 'summary' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                    class="context-chapter-btn"
                                                    :title="(locale, t('context.includeSummaryAll'))">
                                                    üìù <span x-text="(locale, t('context.summary'))"></span>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Scenes List -->
                                        <template x-for="scene in chapter.scenes" :key="scene.id">
                                            <div style="margin-left:16px;margin-bottom:4px;">
                                                <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px;border-radius:4px;"
                                                    @mouseenter="$el.style.background = 'var(--bg-tertiary)'"
                                                    @mouseleave="$el.style.background = 'transparent'">
                                                    <div
                                                        style="font-size:12px;display:flex;align-items:center;gap:6px;">
                                                        <span class="summary-dot"
                                                            :class="{ 'has': scene.summary && !scene.summaryStale, 'stale': scene.summaryStale, 'none': !scene.summary }"
                                                            style="width:8px;height:8px;"></span>
                                                        <span x-text="scene.title"></span>
                                                    </div>
                                                    <div style="display:flex;gap:6px;"
                                                        x-show="!contextPanel.chapters[chapter.id]">
                                                        <button
                                                            @click="setContextScene(scene.id, contextPanel.scenes[scene.id] === 'full' ? null : 'full')"
                                                            :style="contextPanel.scenes[scene.id] === 'full' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                            class="context-scene-btn"
                                                            :title="(locale, t('context.includeFull'))">
                                                            üìÑ <span x-text="(locale, t('context.full'))"></span>
                                                        </button>
                                                        <button
                                                            @click="setContextScene(scene.id, contextPanel.scenes[scene.id] === 'summary' ? null : 'summary')"
                                                            :style="contextPanel.scenes[scene.id] === 'summary' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                            class="context-scene-btn"
                                                            :title="(locale, t('context.includeSummary'))"
                                                            :disabled="!scene.summary">
                                                            üìù <span x-text="(locale, t('context.summary'))"></span>
                                                        </button>
                                                    </div>
                                                    <div style="font-size:10px;color:var(--text-tertiary);padding:2px 6px;"
                                                        x-show="contextPanel.chapters[chapter.id]"
                                                        x-text="(locale, '(' + t('context.viaChapterPrefix') + contextPanel.chapters[chapter.id] + ')')">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Tags Section -->
                        <div
                            style="background:var(--bg-secondary);padding:12px;border-radius:6px;border:1px solid var(--border);">
                            <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">
                                üè∑Ô∏è Tags
                            </div>
                            <template x-if="getAllTags().length === 0">
                                <div style="font-size:12px;color:var(--text-tertiary);padding:8px;text-align:center;">
                                    No tags yet. Add tags to scenes in their summary panel.
                                </div>
                            </template>
                            <div x-show="getAllTags().length > 0" style="display:flex;flex-wrap:wrap;gap:10px;">
                                <template x-for="tag in getAllTags()" :key="tag">
                                    <button @click="toggleContextTag(tag)"
                                        :style="contextPanel.tags.includes(tag) ? 'background:var(--accent);color:white;border-color:var(--accent);font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);border-color:var(--border);'"
                                        class="context-tag-btn"
                                        :title="contextPanel.tags.includes(tag) ? (t('context.tag.excludePrefix') + tag) : (t('context.tag.includePrefix') + tag)"
                                        @mouseenter="if (!contextPanel.tags.includes(tag)) $el.style.borderColor = 'var(--accent)'"
                                        @mouseleave="if (!contextPanel.tags.includes(tag)) $el.style.borderColor = 'var(--border)'"
                                        x-text="tag">
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </template>

        <!-- Rewrite Modal -->
        <div x-show="showRewriteModal" x-cloak class="modal-overlay" @click.self="discardRewrite()">
            <div class="rewrite-modal" @click.stop>
                <div class="modal-header">
                    <h3 style="margin:0;" x-text="(locale, t('rewrite.title'))"></h3>
                    <button class="btn btn-secondary" @click="discardRewrite()" x-text="(locale, t('common.close'))"></button>
                </div>

                <div class="modal-body">
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);" x-text="(locale, t('rewrite.originalText'))"></label>
                        <textarea readonly :value="rewriteOriginalText"
                            style="width:100%;height:120px;padding:10px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;resize:vertical;"></textarea>
                    </div>

                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <button class="btn btn-secondary" @click="buildRewritePrompt()"
                            :disabled="rewriteInProgress" x-text="(locale, t('summary.promptLabel'))"></button>
                        <button class="btn btn-primary" @click="performRewrite()" :disabled="rewriteInProgress">
                            <span x-show="!rewriteInProgress" x-text="(locale, t('rewrite.action'))"></span>
                            <span x-show="rewriteInProgress" x-text="(locale, t('rewrite.progress'))"></span>
                        </button>
                    </div>

                    <div x-show="showRewritePromptList" style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);" x-text="(locale, t('rewrite.selectPrompt'))"></label>
                        <select x-model="selectedRewritePromptId" @change="buildRewritePrompt()"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="" x-text="(locale, t('rewrite.defaultPrompt'))"></option>
                            <template x-for="pr in prompts.filter(p => p.category === 'rewrite')" :key="pr.id">
                                <option :value="pr.id" x-text="pr.title"></option>
                            </template>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-primary);" x-text="(locale, t('rewrite.rewrittenText'))"></label>
                        <textarea readonly :value="rewriteOutput"
                            style="width:100%;height:180px;padding:10px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;resize:vertical;"
                            :placeholder="(locale, t('place.rewrite.output'))"></textarea>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                        <button class="btn btn-primary" @click="acceptRewrite()"
                            x-show="rewriteOutput && !rewriteInProgress" x-text="(locale, t('common.accept'))"></button>
                        <button class="btn btn-secondary" @click="retryRewrite()"
                            x-show="rewriteOutput && !rewriteInProgress" x-text="(locale, t('common.retry'))"></button>
                        <button class="btn btn-secondary" @click="discardRewrite()" x-text="(locale, t('common.discard'))"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Loading Screen -->
        <template x-if="showModelLoading">
            <div class="welcome-screen">
                <div class="welcome-content">
                    <h2 x-text="(locale, t('ai.setup.title'))"></h2>
                    <p x-text="loadingMessage"></p>
                    <div class="loading-bar">
                        <div class="loading-bar-fill" :style="`width: ${loadingProgress}%`"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px;" x-text="`${loadingProgress}%`"></p>
                    <div class="note" x-show="loadingProgress < 100" x-text="(locale, t('loading.mayTakeLong'))"></div>
                </div>
            </div>
        </template>

        <!-- Rewrite modal removed: selecting text shows only the floating Rewrite button -->

        <!-- Welcome Screen (No Project) -->
        <template x-if="!currentProject && !showModelLoading">
            <div class="welcome-screen">
                <div class="welcome-content">
                    <h2 x-text="(locale, t('welcome.noProject.title'))"></h2>
                    <p x-text="(locale, t('welcome.noProject.message'))"></p>
                    <button class="btn btn-primary" @click="showNewProjectModal = true" x-text="(locale, t('welcome.noProject.cta'))"></button>
                    <div class="note">
                        <strong x-text="(locale, t('welcome.noProject.noteTitle'))"></strong>
                        <span x-text="(locale, t('welcome.noProject.noteMessage'))"></span>
                    </div>
                </div>
            </div>
        </template>

        <!-- New Project Modal -->
        <template x-if="showNewProjectModal">
            <div class="modal-overlay" @click.self="showNewProjectModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('project.new.title'))"></h3>
                    <input type="text" x-model="newProjectName" :placeholder="(locale, t('place.project.newName'))"
                        @keydown.enter="createProject">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewProjectModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="createProject" x-text="(locale, t('common.create'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Rename Project Modal -->
        <template x-if="showRenameProjectModal">
            <div class="modal-overlay" @click.self="showRenameProjectModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('modal.renameProject.title'))"></h3>
                    <input type="text" x-model="renameProjectName" :placeholder="(locale, t('modal.renameProject.placeholder'))"
                        @keydown.enter="renameCurrentProject">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showRenameProjectModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="renameCurrentProject" x-text="(locale, t('common.rename'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Export Format Selection Modal -->
        <template x-if="showExportModal">
            <div class="modal-overlay" @click.self="showExportModal = false">
                <div class="modal" style="max-width:500px;">
                    <h3 x-text="(locale, t('export.title'))"></h3>
                    <p style="margin:0 0 20px 0;color:var(--text-secondary);font-size:14px;" x-text="(locale, t('export.chooseFormat'))">
                    </p>

                    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
                        <label
                            style="display:flex;align-items:start;gap:12px;padding:16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;"
                            :style="exportFormat === 'zip' ? 'border-color:var(--accent);background:rgba(74,158,255,0.1);' : ''"
                            @click="exportFormat = 'zip'">
                            <input type="radio" name="exportFormat" value="zip" x-model="exportFormat"
                                style="margin-top:2px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;margin-bottom:4px;">üì¶ <span x-text="(locale, t('export.format.zip'))"></span></div>
                                <div style="font-size:13px;color:var(--text-secondary);" x-text="(locale, t('export.format.zip.description'))"></div>
                            </div>
                        </label>

                        <label
                            style="display:flex;align-items:start;gap:12px;padding:16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;"
                            :style="exportFormat === 'epub' ? 'border-color:var(--accent);background:rgba(74,158,255,0.1);' : ''"
                            @click="exportFormat = 'epub'">
                            <input type="radio" name="exportFormat" value="epub" x-model="exportFormat"
                                style="margin-top:2px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;margin-bottom:4px;">üìö <span x-text="(locale, t('export.format.epub'))"></span></div>
                                <div style="font-size:13px;color:var(--text-secondary);" x-text="(locale, t('export.format.epub.description'))"></div>
                            </div>
                        </label>

                        <label
                            style="display:flex;align-items:start;gap:12px;padding:16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;"
                            :style="exportFormat === 'html' ? 'border-color:var(--accent);background:rgba(74,158,255,0.1);' : ''"
                            @click="exportFormat = 'html'">
                            <input type="radio" name="exportFormat" value="html" x-model="exportFormat"
                                style="margin-top:2px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;margin-bottom:4px;">üåê <span x-text="(locale, t('export.format.html'))"></span></div>
                                <div style="font-size:13px;color:var(--text-secondary);" x-text="(locale, t('export.format.html.description'))"></div>
                            </div>
                        </label>

                        <label
                            style="display:flex;align-items:start;gap:12px;padding:16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;"
                            :style="exportFormat === 'txt' ? 'border-color:var(--accent);background:rgba(74,158,255,0.1);' : ''"
                            @click="exportFormat = 'txt'">
                            <input type="radio" name="exportFormat" value="txt" x-model="exportFormat"
                                style="margin-top:2px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;margin-bottom:4px;">üìÑ <span x-text="(locale, t('export.format.txt'))"></span></div>
                                <div style="font-size:13px;color:var(--text-secondary);" x-text="(locale, t('export.format.txt.description'))"></div>
                            </div>
                        </label>
                    </div>

                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showExportModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="confirmExport()" x-text="(locale, t('export.action'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Import from Writingway 1 Modal -->
        <template x-if="showW1ImportModal">
            <div class="modal-overlay" @click.self="showW1ImportModal = false">
                <div class="modal" style="max-width:600px;">
                    <h3 x-text="(locale, t('projects.importW1.title'))"></h3>
                    <div
                        style="background:rgba(255,200,100,0.1);border:1px solid rgba(255,200,100,0.3);border-radius:8px;padding:16px;margin:16px 0;line-height:1.6;">
                        <p style="margin:0 0 12px 0;font-weight:600;color:#ffcc66;" x-text="(locale, t('w1.importNotes.title'))"></p>
                        <p style="margin:0 0 8px 0;font-size:14px;"><strong x-text="(locale, t('w1.imported.title'))"></strong></p>
                        <ul style="margin:0 0 12px 0;padding-left:24px;font-size:13px;">
                            <li x-text="(locale, t('w1.imported.structure'))"></li>
                            <li x-text="(locale, t('w1.imported.sceneContent'))"></li>
                            <li x-text="(locale, t('w1.imported.summaries'))"></li>
                            <li x-text="(locale, t('w1.imported.compendium'))"></li>
                            <li x-text="(locale, t('w1.imported.prompts'))"></li>
                        </ul>
                        <p style="margin:0 0 8px 0;font-size:14px;"><strong x-text="(locale, t('w1.whatNotImportedTitle'))"></strong></p>
                        <ul style="margin:0 0 0 0;padding-left:24px;font-size:13px;">
                            <li x-text="(locale, t('w1.notImported.relationships'))"></li>
                            <li x-text="(locale, t('w1.notImported.images'))"></li>
                            <li x-text="(locale, t('w1.notImported.sceneMarkers'))"></li>
                            <li x-text="(locale, t('w1.notImported.covers'))"></li>
                        </ul>
                    </div>
                    <p style="margin:16px 0 8px 0;font-size:14px;color:rgba(255,255,255,0.8);" x-text="(locale, t('w1.selectFolder'))"></p>
                    <input type="file" webkitdirectory directory multiple @change="importFromW1($event)"
                        style="margin:8px 0;padding:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:4px;color:inherit;width:100%;">
                    <div class="modal-buttons" style="margin-top:20px;">
                        <button class="btn btn-secondary" @click="showW1ImportModal = false"
                            :disabled="w1ImportInProgress" x-text="(locale, t('common.cancel'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Scene/Chapter Summary Panel -->
        <div class="slide-panel-right summary-panel" :class="{ 'open': showSummaryPanel }" x-cloak aria-hidden="true">
            <div class="slide-panel-header">
                <h3 style="margin:0;" x-text="summaryTargetChapterId ? t('summary.chapter') : t('summary.scene')"></h3>
                <div>
                    <button class="btn btn-secondary" @click="showSummaryPanel = false" x-text="(locale, t('common.close'))"></button>
                </div>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;flex-direction:column;height:100%;">
                    <div style="flex:1;overflow:auto;">
                        <!-- Tags input (scenes only) -->
                        <div x-show="summaryTargetSceneId" style="margin-bottom:12px;">
                            <label
                                style="display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary);font-weight:600;" x-text="(locale, t('summary.tagsLabel'))"></label>
                            <input type="text" x-model="sceneTags" :placeholder="(locale, t('summary.tagsPlaceholder'))"
                                style="width:100%;padding:10px 12px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text-primary);border-radius:6px;font-size:14px;" />
                            <div style="font-size:12px;color:var(--text-tertiary);margin-top:4px;" x-text="(locale, t('summary.tagsHelp'))"></div>
                        </div>
                        <label
                                style="display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary);font-weight:600;"
                                x-text="summaryTargetChapterId ? t('summary.chapter') : t('summary.scene')"></label>
                        <textarea x-model="summaryText" rows="12"
                            style="width:100%;padding:12px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text-primary);border-radius:6px;resize:vertical;"></textarea>
                    </div>

                    <div
                        style="flex:0 0 auto;display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px;position:relative;">
                        <!-- Prompt Selection Button -->
                        <div style="position:relative;">
                            <button class="btn btn-secondary" @click="showSummaryPromptList = !showSummaryPromptList"
                                :title="(locale, t('summary.choosePromptTitle'))" x-text="(locale, t('summary.promptLabel'))"></button>
                            <!-- Prompt Dropdown -->
                            <div x-show="showSummaryPromptList" @click.away="showSummaryPromptList = false" x-cloak
                                style="position:absolute;bottom:100%;left:0;margin-bottom:8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:8px;min-width:280px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:1000;">
                                <div
                                    style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;padding:4px 8px;">
                                    <span x-text="(locale, t('summary.choosePromptTitle'))"></span>
                                </div>
                                <!-- Default option -->
                                <div @click="selectedSummaryPromptId = null; showSummaryPromptList = false"
                                    :style="!selectedSummaryPromptId ? 'background:var(--accent);color:white;' : ''"
                                    style="padding:8px 12px;cursor:pointer;border-radius:4px;margin-bottom:4px;transition:background 0.15s;"
                                    :class="!selectedSummaryPromptId ? '' : 'hover:bg-tertiary'">
                                    <div style="font-weight:600;font-size:13px;">
                                        <span x-text="(locale, t('summary.default'))"></span>
                                        <span x-show="prompts.filter(p => p.category === 'summary').length === 0"
                                            style="font-size:11px;opacity:0.7;" x-text="(locale, t('gen.heuristic'))"></span>
                                    </div>
                                    <div style="font-size:11px;opacity:0.8;">
                                        <span x-show="prompts.filter(p => p.category === 'summary').length > 0" x-text="(locale, t('summary.firstOrFallback'))"></span>
                                    </div>
                                </div>
                                <!-- Summary category prompts -->
                                <template x-for="prompt in prompts.filter(p => p.category === 'summary')"
                                    :key="prompt.id">
                                    <div @click="selectedSummaryPromptId = prompt.id; showSummaryPromptList = false"
                                        :style="selectedSummaryPromptId === prompt.id ? 'background:var(--accent);color:white;' : ''"
                                        style="padding:8px 12px;cursor:pointer;border-radius:4px;margin-bottom:4px;transition:background 0.15s;"
                                        @mouseenter="$el.style.background = selectedSummaryPromptId === prompt.id ? 'var(--accent)' : 'var(--bg-secondary)'"
                                        @mouseleave="$el.style.background = selectedSummaryPromptId === prompt.id ? 'var(--accent)' : 'transparent'">
                                        <div style="font-weight:600;font-size:13px;" x-text="prompt.title"></div>
                                        <div style="font-size:11px;opacity:0.8;"
                                            x-text="(prompt.content || '').slice(0, 60) + '...'"></div>
                                    </div>
                                </template>
                                <!-- No prompts message -->
                                <div x-show="prompts.filter(p => p.category === 'summary').length === 0"
                                    style="padding:12px;text-align:center;color:var(--text-secondary);font-size:12px;">
                                    <span x-text="(locale, t('summary.noPrompts'))"></span><br>
                                    <span style="font-size:11px;opacity:0.7;" x-text="(locale, t('prompts.addOneHint'))"></span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary"
                            @click="summaryTargetChapterId ? summarizeChapter() : summarizeScene()" x-text="(locale, t('summary.run'))"></button>
                        <button class="btn btn-primary"
                            @click="summaryTargetChapterId ? saveChapterSummary() : saveSceneSummary()" x-text="(locale, t('common.save'))"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Settings Panel -->
        <div class="slide-panel-right" :class="{ 'open': showAISettings }" x-cloak
            style="width:600px;border-left:1px solid rgba(74,158,255,0.08);box-shadow:-18px 0 40px rgba(0,0,0,0.55);">
            <div class="slide-panel-header">
                <h3 style="margin:0;" x-text="(locale, t('ai.configuration.title'))"></h3>
                <button class="btn btn-secondary" @click="showAISettings = false" x-text="(locale, t('common.close'))"></button>
            </div>
            <div class="slide-panel-body" style="overflow-y:auto;">
                <!-- Mode Selection -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text-primary);" x-text="(locale, t('ai.mode.title'))"></label>
                    <div style="display:flex;gap:12px;">
                        <button class="btn" :class="aiMode === 'api' ? 'btn-primary' : 'btn-secondary'"
                            @click="aiMode = 'api'; if (aiProvider === 'openrouter' && !aiModel) aiModel = 'google/gemini-2.0-flash-exp:free';"
                            style="flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;">
                            <div style="font-size:20px;margin-bottom:4px;">‚òÅÔ∏è</div>
                            <div style="font-weight:600;" x-text="(locale, t('ai.mode.apiTitle'))"></div
                            ><div style="font-size:11px;opacity:0.7;" x-text="(locale, t('ai.mode.apiSubtitle'))"></div>
                        </button>
                        <button class="btn" :class="aiMode === 'local' ? 'btn-primary' : 'btn-secondary'"
                            @click="aiMode = 'local'; if (availableLocalModels.length > 0 && !aiModel) aiModel = availableLocalModels[0]; scanLocalModels();"
                            style="flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;">
                            <div style="font-size:20px;margin-bottom:4px;">üíª</div>
                            <div style="font-weight:600;" x-text="(locale, t('ai.mode.localTitle'))"></div
                            ><div style="font-size:11px;opacity:0.7;" x-text="(locale, t('ai.mode.localSubtitle'))"></div>
                        </button>
                    </div>
                </div>

                <!-- API Mode Settings -->
                <div x-show="aiMode === 'api'" style="margin-bottom:20px;">
                    <h4 style="margin:0 0 12px 0;" x-text="(locale, t('ai.provider.settings'))"></h4>

                    <div style="margin-bottom:16px;">
                        <label style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);" x-text="(locale, t('ai.provider.label'))"></label>
                        <select x-model="aiProvider"
                            @change="aiModel = (providerModels[aiProvider] && providerModels[aiProvider].length > 0) ? providerModels[aiProvider].find(m => m.recommended)?.id || providerModels[aiProvider][0].id : ''; modelsFetched = false;"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="openrouter" x-text="(locale, t('ai.provider.openrouter'))"></option>
                            <option value="anthropic" x-text="(locale, t('ai.provider.anthropic'))"></option>
                            <option value="openai" x-text="(locale, t('ai.provider.openai'))"></option>
                            <option value="google" x-text="(locale, t('ai.provider.google'))"></option>
                            <option value="custom" x-text="(locale, t('ai.provider.custom'))"></option>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);" x-text="(locale, t('ai.apiKey.label'))"></label>
                        <input type="password" x-model="aiApiKey" :placeholder="(locale, t('place.ai.apiKey'))"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;">
                            <template x-if="aiProvider === 'openrouter'"><span x-text="(locale, t('ai.key.freePrefix'))"></span><a
                                    href="https://openrouter.ai/keys" target="_blank"
                                    style="color:var(--accent);">openrouter.ai/keys</a></template>
                            <template x-if="aiProvider === 'anthropic'"><span x-text="(locale, t('ai.key.getAtPrefix'))"></span><a
                                    href="https://console.anthropic.com/" target="_blank"
                                    style="color:var(--accent);">console.anthropic.com</a></template>
                            <template x-if="aiProvider === 'openai'"><span x-text="(locale, t('ai.key.getAtPrefix'))"></span><a
                                    href="https://platform.openai.com/api-keys" target="_blank"
                                    style="color:var(--accent);">platform.openai.com/api-keys</a></template>
                            <template x-if="aiProvider === 'google'"><span x-text="(locale, t('ai.key.getAtPrefix'))"></span><a
                                    href="https://makersuite.google.com/app/apikey" target="_blank"
                                    style="color:var(--accent);">Google AI Studio</a></template>
                        </p>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <label style="display:block;font-size:13px;font-weight:600;color:var(--text-primary);" x-text="(locale, t('gen.model.label'))"></label>
                            <button class="btn btn-secondary" @click="fetchProviderModels()"
                                :disabled="!aiApiKey || fetchingModels" style="font-size:11px;padding:4px 8px;"
                                :title="(locale, t('ai.scanModels'))">
                                <span x-show="!fetchingModels">üîÑ <span x-text="(locale, t('common.refresh'))"></span></span>
                                <span x-show="fetchingModels">‚è≥ <span x-text="(locale, t('common.loading'))"></span></span>
                            </button>
                        </div>
                        <select x-model="aiModel"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="" disabled x-text="(locale, t('ai.model.selectPlaceholder'))"></option>
                            <template x-for="model in providerModels[aiProvider] || []" :key="model.id">
                                <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                </option>
                            </template>
                            <!-- Show current model if not in list -->
                            <option x-show="aiModel && !(providerModels[aiProvider] || []).find(m => m.id === aiModel)"
                                :value="aiModel" x-text="aiModel"></option>
                        </select>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;"
                            x-show="modelsFetched && aiMode === 'api'">
                            <span x-text="(locale, t('ai.modelListUpdated'))"></span>
                        </p>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;"
                            x-show="!aiApiKey && aiMode === 'api'">
                            <span x-text="(locale, t('ai.enterKeyToViewModels'))"></span>
                        </p>
                    </div>

                    <!-- Force Non-Streaming Toggle (for API mode only) -->
                    <div x-show="aiMode === 'api'" style="margin-bottom:16px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" x-model="forceNonStreaming" @change="saveGenerationParams()"
                                style="width:16px;height:16px;cursor:pointer;">
                            <span style="font-size:13px;color:var(--text-primary);" x-text="(locale, t('ai.forceNonStreaming'))"></span>
                        </label>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;padding-left:24px;">
                            <span x-text="(locale, t('ai.streaming.help'))"></span>
                        </p>
                    </div>

                    <div x-show="aiProvider === 'custom'" style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">Custom
                            <span x-text="(locale, t('ai.api.endpoint'))"></span></label>
                        <input type="text" x-model="aiEndpoint"
                            :placeholder="(locale, t('place.ai.apiUrl'))"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                    </div>
                </div>

                <!-- Local Mode Settings -->
                <div x-show="aiMode === 'local'" style="margin-bottom:20px;">
                    <h4 style="margin:0 0 12px 0;" x-text="(locale, t('ai.local.settingsTitle'))"></h4>

                    <div
                        style="background:rgba(74,158,255,0.05);border:1px solid rgba(74,158,255,0.2);border-radius:6px;padding:12px;margin-bottom:16px;">
                        <p style="font-size:12px;color:var(--text-secondary);margin:0;">üìÅ <span x-text="(locale, t('ai.gguf.place.prefix'))"></span>
                            <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">/models</code>
                            <span x-text="(locale, t('ai.gguf.place.suffix'))"></span></p>
                    </div>

                    <button class="btn btn-secondary" @click="scanLocalModels()" style="margin-bottom:16px;">üîç <span x-text="(locale, t('ai.scanModels'))"></span></button>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);"><span x-text="(locale, t('ai.local.status'))"></span></label>
                        <div
                            style="padding:12px;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:6px;">
                            <p style="font-size:12px;color:var(--text-secondary);margin:0;">
                                <span x-text="(locale, t('ai.local.status.loaded'))"></span><br>
                                <span style="font-size:11px;opacity:0.8;" x-text="(locale, t('ai.local.status.fileInfo'))"></span>
                            </p>
                        </div>
                    </div>

                    <div
                        style="margin-top:12px;padding:10px;background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.3);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:0;line-height:1.5;">
                            <span x-text="(locale, t('ai.local.changeNote'))"></span>
                        </p>
                    </div>

                    <div style="margin-top:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);"><span x-text="(locale, t('ai.local.serverUrl'))"></span></label>
                        <input type="text" x-model="aiEndpoint" value="http://localhost:8080"
                            :placeholder="(locale, t('place.ai.localUrl'))"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;" x-text="(locale, t('ai.local.endpointTip'))"></p>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="display:flex;gap:8px;padding-top:16px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" @click="saveAISettings()">üíæ <span x-text="(locale, t('ai.saveAndTest'))"></span></button
                    <button class="btn btn-secondary" @click="showAISettings = false" x-text="(locale, t('common.cancel'))"></button>
                </div>

                <!-- TTS Settings Section -->
                <div style="margin-top:32px;padding-top:24px;border-top:2px solid var(--border);">
                    <h4 style="margin:0 0 16px 0;color:var(--text-primary);">üîä <span x-text="(locale, t('tts.title'))"></span></h4>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">
                            <span x-text="(locale, t('tts.voice'))"></span>
                        </label>
                        <select x-model="ttsVoiceName" @change="saveTTSSettings()"
                            style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                            <option value="" x-text="(locale, t('tts.defaultVoice'))"></option>
                            <template x-for="voice in availableTTSVoices" :key="voice.name">
                                <option :value="voice.name" x-text="`${voice.name} (${voice.lang})`"></option>
                            </template>
                        </select>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;">
                            <span x-text="(locale, t('tts.chromeTip'))"></span>
                        </p>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary);">
                            <span x-text="(locale, t('tts.readingSpeed'))"></span>: <span x-text="ttsSpeed.toFixed(1) + 'x'"></span>
                        </label>
                        <input type="range" x-model.number="ttsSpeed" @input="saveTTSSettings()" min="0.5" max="2.0"
                            step="0.1" style="width:100%;margin-top:6px;">
                        <div
                            style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                            <span x-text="(locale, t('tts.speed.slower'))"></span>
                            <span x-text="(locale, t('tts.speed.normal'))"></span>
                            <span x-text="(locale, t('tts.speed.faster'))"></span>
                        </div>
                        <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;">
                            Higher speeds are useful when editing - you can catch errors faster
                        </p>
                    </div>

                    <div
                        style="background:rgba(74,158,255,0.05);border:1px solid rgba(74,158,255,0.2);border-radius:6px;padding:12px;">
                        <p style="font-size:12px;color:var(--text-secondary);margin:0;line-height:1.5;">
                            <span x-text="(locale, t('tts.editTip'))"></span> <strong></strong> <span x-text="(locale, t('tts.editText'))"></span>!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitHub Backup Settings Panel -->
        <div class="slide-panel-right" :class="{ 'open': showBackupSettings }" x-cloak>
            <div class="slide-panel-header">
                <h3 style="margin:0;">‚òÅÔ∏è <span x-text="(locale, t('backup.title'))"></span></h3>
                <button class="btn btn-secondary" @click="closeBackupSettings()" x-text="(locale, t('common.close'))"></button>
            </div>
            <div class="slide-panel-body" style="padding:20px;">
                <div
                    style="background:rgba(74,158,255,0.1);border:1px solid rgba(74,158,255,0.3);border-radius:8px;padding:16px;margin-bottom:24px;">
                    <h4 style="margin:0 0 12px 0;color:var(--text-primary);" x-text="(locale, t('backup.instructions.title'))"></h4>
                    <ol style="margin:0;padding-left:20px;line-height:1.8;font-size:14px;">
                        <li><span x-text="(locale, t('backup.instructions.goTo'))"></span> <a href="https://github.com/settings/tokens" target="_blank"
                                style="color:#4a9eff;" x-text="(locale, t('backup.instructions.githubLinkText'))"></a>
                        </li>
                        <li x-text="(locale, t('backup.instructions.generateClassic'))"></li>
                        <li x-text="(locale, t('backup.instructions.giveName'))"></li>
                        <li><span x-text="(locale, t('backup.instructions.expiration'))"></span> <strong x-text="(locale, t('backup.instructions.noExpiration'))"></strong></li>
                        <li><span x-text="(locale, t('backup.instructions.selectPermission'))"></span> <strong>gist</strong> <span x-text="(locale, t('backup.instructions.onlyThis'))"></span></li>
                        <li x-text="(locale, t('backup.instructions.generateAndCopy'))"></li>
                        <li x-text="(locale, t('backup.instructions.pasteBelow'))"></li>
                    </ol>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;" x-text="(locale, t('backup.github.token'))"></label>
                    <input type="password" x-model="githubToken" :placeholder="(locale, t('place.github.token'))"
                        style="width:100%;padding:10px;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:monospace;font-size:13px;">
                    <p style="font-size:12px;color:var(--text-secondary);margin-top:8px;">
                        <span x-show="githubUsername" style="color:#4caf50;">‚úì <span x-text="(locale, t('backup.connectedAs'))"></span> <strong x-text="githubUsername"></strong></span>
                    </p>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" x-model="backupEnabled" style="width:18px;height:18px;">
                        <span style="font-weight:600;" x-text="(locale, t('backup.enableAuto'))"></span>
                    </label>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <button class="btn btn-primary" @click="saveBackupSettings()" style="flex:1;" x-text="(locale, t('common.saveSettings'))">
                    </button>
                    <button class="btn btn-secondary" @click="backupNow()" style="flex:1;" x-text="(locale, t('backup.now'))"></button>
                </div>

                <div x-show="backupStatus"
                    style="padding:12px;background:rgba(74,158,255,0.1);border:1px solid rgba(74,158,255,0.3);border-radius:6px;margin-bottom:20px;">
                    <p style="margin:0;font-size:14px;" x-text="backupStatus"></p>
                    <p x-show="lastBackupTime" style="margin:8px 0 0 0;font-size:12px;color:var(--text-secondary);">
                        <span x-text="(locale, t('backup.lastBackup'))"></span> <span
                            x-text="lastBackupTime ? new Date(lastBackupTime).toLocaleString() : t('backup.never')"></span>
                    </p>
                </div>

                <div style="border-top:1px solid var(--border);padding-top:20px;">
                    <button class="btn btn-secondary" @click="openRestoreModal()"
                        :disabled="!githubToken || !currentProjectGistId" style="width:100%;">
                        üì• <span x-text="(locale, t('backup.restoreFromButton'))"></span>
                    </button>
                </div>

                <div
                    style="margin-top:20px;padding:16px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;">
                    <p style="margin:0;font-size:13px;line-height:1.6;">
                        <strong x-text="(locale, t('backup.note.title'))"></strong>
                        <span x-text="(locale, t('backup.note.gist'))"></span>
                        <span x-text="(locale, t('backup.note.includes'))"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Restore Backup Modal -->
        <div x-show="showRestoreModal" class="modal-backdrop" @click.self="closeRestoreModal()" x-cloak
            style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;">
            <div class="modal-content"
                style="background:var(--bg-secondary);padding:24px;border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;">
                <h3 style="margin:0 0 20px 0;" x-text="(locale, t('backup.modal.title'))"></h3>

                <div x-show="backupList.length === 0"
                    style="text-align:center;padding:40px;color:var(--text-secondary);">
                    <p x-text="(locale, t('backup.loading'))"></p>
                </div>

                <div x-show="backupList.length > 0">
                    <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px;" x-text="(locale, t('backup.selectVersion'))"></p>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <template x-for="backup in backupList" :key="backup.version">
                            <div
                                style="padding:16px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;">
                                <div
                                    style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                                    <div>
                                        <div style="font-weight:600;color:var(--text-primary);"
                                            x-text="new Date(backup.timestamp).toLocaleString()"></div>
                                        <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                            <span x-text="(locale, t('backup.versionLabel'))"></span> <span x-text="backup.version.substring(0, 7)"></span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" @click="restoreBackup(backup.url)"
                                        style="padding:8px 16px;font-size:13px;" x-text="(locale, t('backup.restoreAction'))"></button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div style="margin-top:24px;display:flex;justify-content:flex-end;">
                    <button class="btn btn-secondary" @click="closeRestoreModal()" x-text="(locale, t('common.cancel'))"></button>
                </div>
            </div>
        </div>

        <!-- Prompts Slide Panel -->
        <div class="slide-panel-right prompts-panel" :class="{ 'open': showPromptsPanel }" x-cloak aria-hidden="true">
            <div class="slide-panel-header">
                <h3 style="margin:0;" x-text="(locale, t('prompts.title'))"></h3>
                <div>
                    <button class="btn btn-secondary" @click="showPromptsPanel = false" x-text="(locale, t('common.close'))"></button>
                </div>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;gap:12px;height:100%;">
                    <div style="width:40%;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="color:var(--text-primary);" x-text="(locale, t('compendium.categories'))"></strong>
                        </div>

                        <template x-for="cat in promptCategories" :key="cat">
                            <div style="margin-bottom:12px;">
                                <div class="comp-category" :class="{ 'active': promptCollapsed[cat] === false }"
                                    tabindex="0" role="button" @click="promptCollapsed[cat] = !promptCollapsed[cat]">
                                    <div class="comp-category-label" style="text-transform:capitalize;" x-text="cat">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:6px;">
                                        <div class="comp-category-count"
                                            style="font-size:12px;color:var(--text-secondary);"
                                            x-text="(prompts.filter(p => p.category === cat) || []).length"></div>
                                        <button class="btn btn-secondary" style="padding:2px 8px;font-size:14px;"
                                            @click.stop="createPrompt(cat)">+</button>
                                    </div>
                                </div>

                                <div x-show="!promptCollapsed[cat]" x-cloak style="margin-top:6px;">
                                    <template x-for="pr in prompts.filter(p => p.category === cat)" :key="pr.id">
                                        <div class="comp-entry"
                                            :class="{ 'active': currentPrompt && currentPrompt.id === pr.id }"
                                            tabindex="0">
                                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                                <div style="flex:1;cursor:pointer;" @click.stop="openPrompt(pr.id)">
                                                    <div class="comp-entry-title" x-text="pr.title"></div>
                                                    <div class="comp-entry-meta"
                                                        style="font-size:11px;color:var(--text-secondary);"
                                                        x-text="new Date(pr.modified).toLocaleString()"></div>
                                                </div>

                                                <div class="item-actions" style="margin-left:8px;"
                                                    x-data="{ openMenu:false }">
                                                    <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                        :title="(locale, t('common.more'))">‚ãØ</button>
                                                    <div x-show="openMenu" x-cloak @click.away="openMenu = false"
                                                        x-transition class="action-menu">
                                                        <button @click.stop="movePromptUp(pr.id); openMenu=false">Move
                                                            up</button>
                                                        <button @click.stop="movePromptDown(pr.id); openMenu=false" x-text="(locale, t('common.moveDown'))"></button>
                                                        <button
                                                            @click.stop="renamePrompt(pr.id); openMenu=false" x-text="(locale, t('common.rename'))"></button>
                                                        <button
                                                            @click.stop="deletePrompt(pr.id); openMenu=false" x-text="(locale, t('common.delete'))"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div style="flex:1;display:flex;flex-direction:column;">
                        <div style="flex:0 0 auto;margin-bottom:6px;">
                            <div x-show="!currentPrompt" style="color:var(--text-secondary);">Select a prompt or create
                                a new one.</div>
                            <div x-show="currentPrompt">
                                <input type="text" x-model="currentPrompt.title"
                                    style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;margin-bottom:6px;">
                                <div style="margin-bottom:6px;">
                                    <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;" x-text="(locale, t('prompts.categoryLabel'))"></label>
                                    <select x-model="currentPrompt.category"
                                        style="width:100%;padding:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);border-radius:6px;">
                                        <template x-for="cat in promptCategories" :key="cat">
                                            <option :value="cat" x-text="cat" style="text-transform:capitalize;">
                                            </option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="flex:1;overflow:auto;">
                            <textarea x-model="promptEditorContent"
                                style="width:100%;height:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;"></textarea>
                        </div>
                        <div style="flex:0 0 auto;display:flex;gap:8px;margin-top:8px;">
                            <button class="btn btn-primary" @click="savePrompt" :disabled="!currentPrompt" x-text="(locale, t('common.save'))"></button>
                            <button class="btn btn-secondary" @click="deletePrompt(currentPrompt.id)"
                                x-show="currentPrompt" x-text="(locale, t('common.delete'))"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compendium Slide Panel -->
        <div id="compendium-panel" class="slide-panel-right compendium-panel" :class="{ 'open': showCodexPanel }"
            x-cloak :aria-hidden="!showCodexPanel">
            <div class="slide-panel-header">
                <h3 style="margin:0;" x-text="(locale, t('compendium.title'))"></h3>
                <div>
                    <button class="btn btn-secondary" @click="showCodexPanel = false" x-text="(locale, t('common.close'))"></button>
                </div>
            </div>
            <div class="slide-panel-body">
                <div style="display:flex;gap:12px;height:100%;">
                    <div style="width:40%;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="color:var(--text-primary);" x-text="(locale, t('prompts.categoriesTitle'))"></strong>
                        </div>

                        <template x-for="cat in compendiumCategories" :key="cat">
                            <div style="margin-bottom:12px;">
                                <div class="comp-category" :class="{ 'active': currentCompCategory === cat }"
                                    tabindex="0" role="button" @click="loadCompendiumCategory(cat)"
                                    @keydown.enter="loadCompendiumCategory(cat)">
                                    <div class="comp-category-label"
                                        style="text-transform:capitalize;font-weight:700;color:var(--text-primary);"
                                        x-text="cat"></div>
                                    <div style="display:flex;align-items:center;gap:6px;">
                                        <div class="comp-category-count"
                                            style="font-size:12px;color:var(--text-secondary);"
                                            x-text="(compendiumCounts[cat] || 0)"></div>
                                        <button class="btn btn-secondary" style="padding:2px 8px;font-size:14px;"
                                            @click.stop="createCompendiumEntry(cat)"
                                            :title="(locale, t('compendium.newEntry'))">+</button>
                                    </div>
                                </div>
                                <div x-show="currentCompCategory === cat" x-cloak style="margin-top:6px;">
                                    <template x-for="e in compendiumList" :key="e.id">
                                        <div class="comp-entry"
                                            :class="{ 'active': currentCompEntry && currentCompEntry.id === e.id }"
                                            tabindex="0">
                                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                                <div style="flex:1;cursor:pointer;" @click="selectCompendiumEntry(e.id)"
                                                    @keydown.enter="selectCompendiumEntry(e.id)">
                                                    <div class="comp-entry-title" x-text="e.title"></div>
                                                    <div class="comp-entry-meta"
                                                        x-text="new Date(e.modified).toLocaleString()"></div>
                                                </div>

                                                <div class="item-actions" style="margin-left:8px;"
                                                    x-data="{ openMenu:false }">
                                                    <button class="menu-button" @click.stop="openMenu = !openMenu"
                                                        :title="(locale, t('common.more'))">‚ãØ</button>
                                                    <div x-show="openMenu" x-cloak @click.away="openMenu = false"
                                                        x-transition class="action-menu">
                                                        <div class="menu-row">
                                                            <label
                                                                style="font-size:12px;color:var(--text-secondary);flex:1;display:flex;gap:6px;align-items:center;">
                                                                <span x-text="(locale, t('common.moveTo'))"></span>
                                                                <select class="move-select"
                                                                    @change.stop="moveCompendiumEntryToCategory(e.id, $event.target.value); openMenu=false;">
                                                                    <option value="" disabled selected x-text="(locale, t('common.chooseCategory'))"></option>
                                                                    <template x-for="cat in compendiumCategories"
                                                                        :key="cat">
                                                                        <option :value="cat"
                                                                            :selected="cat === e.category" x-text="cat">
                                                                        </option>
                                                                    </template>
                                                                </select>
                                                            </label>
                                                        </div>
                                                        <button
                                                            @click.stop="moveCompendiumEntryUp(e.id); openMenu=false" x-text="(locale, t('common.moveUp'))"></button>
                                                        <button
                                                            @click.stop="moveCompendiumEntryDown(e.id); openMenu=false" x-text="(locale, t('common.moveDown'))"></button>
                                                        <button
                                                            @click.stop="deleteCompendiumEntry(e.id); openMenu=false" x-text="(locale, t('common.deleteEntry'))"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div style="flex:1;display:flex;flex-direction:column;">
                        <div style="flex:0 0 auto;margin-bottom:6px;">
                            <template x-if="!currentCompEntry">
                                <div style="color:var(--text-secondary);" x-text="(locale, t('compendium.selectOrCreate'))"></div>
                            </template>
                            <template x-if="currentCompEntry">
                                <div>
                                    <input type="text" x-model="currentCompEntry.title" :placeholder="(locale, t('compendium.entryTitle'))"
                                        style="width:100%;padding:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;margin-bottom:6px;">
                                </div>
                            </template>
                        </div>
                        <div style="flex:1;overflow:auto;">
                            <template x-if="currentCompEntry">
                                <div class="comp-editor-vertical">
                                    <!-- Image under the title -->
                                    <label class="comp-image-preview comp-image-block" tabindex="0"
                                        @click.prevent="$refs.compImageInput.click()" @dragover.prevent
                                        @drop.prevent="setCompImageFromFile($event)">
                                        <template x-if="currentCompEntry.imageUrl">
                                            <img :src="currentCompEntry.imageUrl" alt="Entry image preview"
                                                @click.stop="confirmRemoveCompImage()">
                                        </template>
                                        <template x-if="!currentCompEntry.imageUrl">
                                            <div class="comp-image-placeholder" x-text="(locale, t('compendium.dropImage'))"></div>
                                        </template>
                                        <input x-ref="compImageInput" type="file" accept="image/*"
                                            @change="setCompImageFromFile($event)" style="display:none">
                                    </label>

                                    <!-- Body below the image -->
                                    <textarea x-model="currentCompEntry.body"
                                        :placeholder="(locale, t('compendium.bodyPlaceholder'))" class="comp-editor-body"
                                        style="margin-top:12px;"></textarea>

                                    <!-- Tags and image remove button -->
                                    <div
                                        style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px;">
                                        <div class="comp-tags">
                                            <div class="tag-list">
                                                <template x-for="(t,ti) in (currentCompEntry.tags || [])" :key="ti">
                                                    <span class="tag-chip" @click.stop="removeCompTag(ti)"
                                                        :title="(locale, t('compendium.removeTag'))" x-text="t"></span>
                                                </template>
                                            </div>
                                            <input class="tag-input" x-model="newCompTag"
                                                :placeholder="(locale, t('compendium.addTagPlaceholder'))"
                                                @keydown.enter.prevent="addCompTag()">
                                        </div>

                                        <div style="display:flex;gap:8px;align-items:center;">
                                            <!-- Image removal handled by clicking the image itself -->
                                        </div>
                                    </div>

                                    <!-- Always in Context checkbox -->
                                    <div
                                        style="margin-top:12px;padding:12px;background:rgba(74,158,255,0.05);border:1px solid rgba(74,158,255,0.2);border-radius:6px;">
                                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                            <input type="checkbox" x-model="currentCompEntry.alwaysInContext"
                                                    style="cursor:pointer;">
                                                <span style="font-size:14px;color:rgba(255,255,255,0.9);" x-text="(locale, t('compendium.alwaysInclude'))"></span>
                                        </label>
                                        <p
                                                style="margin:6px 0 0 26px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.4;"
                                                x-text="(locale, t('compendium.alwaysInclude.help'))"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div style="flex:0 0 auto;display:flex;gap:8px;margin-top:8px;align-items:center;">
                            <button class="btn btn-primary" @click="saveCompendiumEntry"
                                :disabled="!currentCompEntry" x-text="(locale, t('common.save'))"></button>
                            <span style="margin-left:8px;font-size:13px;color:var(--text-secondary);"
                                class="compendium-save-status"
                                :class="{ 'saving': compendiumSaveStatus === 'Saving...' }"
                                x-text="compendiumSaveStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Scene Modal -->
        <template x-if="showNewSceneModal">
            <div class="modal-overlay" @click.self="showNewSceneModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('modal.newScene.title'))"></h3>
                    <input type="text" x-model="newSceneName" :placeholder="(locale, t('modal.newScene.placeholder'))"
                        @keydown.enter="createScene">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewSceneModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="createScene" x-text="(locale, t('common.create'))"></button>
                    </div>
                </div>
            </div>
        </template>
        <!-- New Chapter Modal -->
        <template x-if="showNewChapterModal">
            <div class="modal-overlay" @click.self="showNewChapterModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('modal.newChapter.title'))"></h3>
                    <input type="text" x-model="newChapterName" :placeholder="(locale, t('modal.newChapter.placeholder'))"
                        @keydown.enter="createChapter">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showNewChapterModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="createChapter" x-text="(locale, t('common.create'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Rename Chapter Modal -->
        <template x-if="showRenameChapterModal">
            <div class="modal-overlay" @click.self="showRenameChapterModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('modal.renameChapter.title'))"></h3>
                    <input type="text" x-model="renameChapterName" :placeholder="(locale, t('modal.renameChapter.placeholder'))"
                        @keydown.enter="renameChapter">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showRenameChapterModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="renameChapter" x-text="(locale, t('common.rename'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Rename Scene Modal -->
        <template x-if="showRenameSceneModal">
            <div class="modal-overlay" @click.self="showRenameSceneModal = false">
                <div class="modal">
                    <h3 x-text="(locale, t('modal.renameScene.title'))"></h3>
                    <input type="text" x-model="renameSceneName" :placeholder="(locale, t('modal.renameScene.placeholder'))" @keydown.enter="renameScene">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" @click="showRenameSceneModal = false" x-text="(locale, t('common.cancel'))"></button>
                        <button class="btn btn-primary" @click="renameScene" x-text="(locale, t('common.rename'))"></button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Prompt History Modal -->
        <template x-if="showPromptHistory">
            <div class="modal-overlay" @click.self="showPromptHistory = false">
                <div class="modal" style="max-width:900px;max-height:80vh;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;" x-text="(locale, t('promptHistory.title'))"></h3>
                        <button class="btn btn-secondary" @click="showPromptHistory = false" x-text="(locale, t('common.close'))"></button>
                    </div>

                    <div style="overflow:auto;max-height:calc(80vh - 100px);">
                        <template x-if="promptHistoryList.length === 0">
                                    <div style="color:var(--text-secondary);text-align:center;padding:40px;" x-text="(locale, t('promptHistory.none'))"></div>
                        </template>

                        <template x-for="(item, idx) in promptHistoryList" :key="item.id">
                            <div
                                style="border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:12px;background:var(--bg-secondary);">
                                <div
                                    style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                    <div style="flex:1;">
                                        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">
                                            <span x-text="new Date(item.timestamp).toLocaleString()"></span>
                                            <template x-if="item.sceneId">
                                                <span> ‚Ä¢ <span x-text="(locale, t('promptHistory.sceneLabel'))"></span> <span
                                                        x-text="scenes.find(s => s.id === item.sceneId)?.title || t('common.unknown')"></span></span>
                                            </template>
                                        </div>
                                        <div style="font-weight:500;margin-bottom:8px;">
                                            <strong style="color:var(--text-secondary);font-size:11px;" x-text="(locale, t('promptHistory.beatLabel'))"></strong>
                                            <div style="color:var(--text-primary);font-size:13px;margin-top:2px;"
                                                x-text="item.beat"></div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary"
                                            @click="beatInput = item.beat; showPromptHistory = false"
                                            style="font-size:11px;padding:4px 8px;" x-text="(locale, t('promptHistory.reuseBeat'))"></button>
                                </div>

                                <details style="margin-top:8px;">
                                    <summary
                                            style="cursor:pointer;color:var(--text-secondary);font-size:11px;user-select:none;"
                                            x-text="(locale, t('promptHistory.viewFullPrompt'))"></summary>
                                    <pre style="margin-top:8px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:4px;font-size:11px;overflow:auto;max-height:300px;white-space:pre-wrap;word-wrap:break-word;"
                                        x-text="item.prompt"></pre>
                                </details>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- Update Available Dialog -->
        <template x-if="showUpdateDialog && updateAvailable">
            <div class="modal-overlay" @click.self="showUpdateDialog = false" style="z-index:10000;">
                <div class="modal" style="max-width:600px;">
                    <div class="modal-header">
                        <h3 style="margin:0;display:flex;align-items:center;gap:8px;">
                            <span style="font-size:24px;">üéâ</span>
                            <span x-text="(locale, t('update.available'))"></span>
                        </h3>
                        <button class="btn-icon" @click="showUpdateDialog = false" :aria-label="(locale, t('common.close'))">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div
                            style="background:linear-gradient(135deg,rgba(74,158,255,0.1),rgba(74,158,255,0.05));border:1px solid rgba(74,158,255,0.3);border-radius:8px;padding:16px;margin-bottom:16px;">
                            <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:var(--accent);" x-text="(locale, t('update.available'))"></div>
                            <div style="font-size:13px;color:var(--text-secondary);">
                                <span x-text="(locale, t('update.latestCommitPrefix'))"></span> (<span x-text="updateAvailable.version"></span>) <span x-text="(locale, t('update.fromPrefix'))"></span> <span x-text="updateAvailable.commitDate"></span>
                            </div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600;margin-bottom:8px;color:var(--text-primary);" x-text="(locale, t('update.latestChange'))"></div>
                            <div style="background:var(--bg-tertiary);padding:12px;border-radius:6px;">
                                <div style="margin:0;font-size:13px;line-height:1.6;color:var(--text-secondary);"
                                    x-text="updateAvailable.message"></div>
                            </div>
                        </div>

                        <div
                            style="background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:6px;padding:12px;margin-bottom:16px;">
                            <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;">
                                <strong x-text="(locale, t('update.note.title'))"></strong> <span x-text="(locale, t('update.note.body'))"></span>
                                <ol style="margin:8px 0 0 0;padding-left:20px;">
                                    <li x-text="(locale, t('update.note.download'))"></li>
                                    <li x-text="(locale, t('update.note.extract'))"></li>
                                    <li x-text="(locale, t('update.note.projectsStored'))"></li>
                                    <li x-text="(locale, t('update.note.backup'))"></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showUpdateDialog = false" x-text="(locale, t('update.maybeLater'))"></button>
                        <button class="btn btn-primary"
                            @click="window.open(updateAvailable.url, '_blank'); showUpdateDialog = false;">
                            üëâ <span x-text="(locale, t('update.viewRelease'))"></span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Scene Options Modal -->
        <template x-if="showSceneOptions">
            <div class="modal-overlay" @click.self="showSceneOptions = false">
                <div class="modal" style="max-width:400px;max-height:90vh;overflow-y:auto;">
                    <div class="modal-header">
                        <h3 style="margin:0;" x-text="(locale, t('scene.options.title'))"></h3>
                        <button class="btn btn-secondary" @click="showSceneOptions = false" x-text="(locale, t('common.close'))"></button>
                    </div>
                    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px;">
                        <label style="font-size:12px;color:var(--text-secondary);"><span x-text="(locale, t('pov.character.label'))"></span>
                            <input type="text" x-model="povCharacter" :placeholder="(locale, t('place.scene.pov'))" list="character-list"
                                @blur="saveScene()" @keydown.enter.prevent="saveScene()"
                                style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <datalist id="character-list">
                                <template x-for="char in compendiumList.filter(c => c.category === 'characters')"
                                    :key="char.id">
                                    <option :value="char.title"></option>
                                </template>
                            </datalist>
                        </label>

                        <label style="font-size:12px;color:var(--text-secondary);" x-text="(locale, t('pov.label'))"></label>
                        <select x-model="pov" @change="saveScene()"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <option value="3rd person limited" x-text="(locale, t('pov.option.3rdLimited'))"></option
                            ><option value="1st person" x-text="(locale, t('pov.option.1stPerson'))"></option
                            ><option value="omniscient" x-text="(locale, t('pov.option.omniscient'))"></option>
                        </select>

                        <label style="font-size:12px;color:var(--text-secondary);" x-text="(locale, t('tense.label'))"></label>
                        <select x-model="tense" @change="saveScene()"
                            style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                            <option value="past" x-text="(locale, t('tense.option.past'))"></option
                            ><option value="present" x-text="(locale, t('tense.option.present'))"></option>
                        </select>

                        <label style="font-size:12px;color:var(--text-secondary);">
                                <span x-text="(locale, t('prose.promptLabel'))"></span>
                                <select x-model="selectedProsePromptId"
                                    @change="saveSelectedProsePrompt(selectedProsePromptId)"
                                    style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                    <option value="" x-text="(locale, t('prose.useCurrentPromptFallback'))"></option>
                                <template x-for="pr in prompts.filter(p => p.category === 'prose')" :key="pr.id">
                                    <option :value="pr.id" x-text="pr.title"></option>
                                </template>
                            </select>
                        </label>

                        <!-- Generation Settings -->
                        <div style="padding-top:16px;border-top:1px solid var(--border);">
                            <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:12px;" x-text="(locale, t('gen.settings.title'))"></div>

                            <!-- Model Selection -->
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:12px;"
                                :title="(locale, t('gen.model.help'))">
                                <span x-text="(locale, t('gen.model.label'))"></span>
                                <select x-model="aiModel" @change="saveGenerationParams()"
                                    style="width:100%;margin-top:6px;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                                    <!-- API mode models -->
                                    <template
                                        x-for="model in (aiMode === 'api' ? (providerModels[aiProvider] || []) : [])"
                                        :key="model.id">
                                        <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                                        </option>
                                    </template>
                                    <!-- Local mode models -->
                                    <template x-for="modelName in (aiMode === 'local' ? availableLocalModels : [])"
                                        :key="modelName">
                                        <option :value="modelName" x-text="modelName"></option>
                                    </template>
                                    <!-- Show current model if not in lists -->
                                    <option
                                        x-show="aiModel && ((aiMode === 'api' && !(providerModels[aiProvider] || []).find(m => m.id === aiModel)) || (aiMode === 'local' && !availableLocalModels.includes(aiModel)))"
                                        :value="aiModel" x-text="aiModel"></option>
                                    <!-- Fallback for local mode with no models -->
                                    <option x-show="aiMode === 'local' && availableLocalModels.length === 0 && !aiModel"
                                        value="" disabled x-text="(locale, t('ai.local.model.placeholder'))"></option>
                                </select>
                            </label>

                            <!-- Use Provider Defaults Toggle -->
                            <div style="margin-bottom:16px;">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" x-model="useProviderDefaults"
                                        @change="saveGenerationParams()" style="width:16px;height:16px;cursor:pointer;">
                                    <span style="font-size:13px;color:var(--text-primary);" x-text="(locale, t('ai.useProviderDefaults'))"></span>
                                </label>
                                <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0 0;padding-left:24px;">
                                    <span x-text="(locale, t('ai.useProviderDefaults.help'))"></span>
                                </p>
                            </div>

                            <!-- Temperature -->
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:12px;"
                                :title="(locale, t('gen.temperature.help'))"
                                :style="useProviderDefaults ? 'opacity:0.5;pointer-events:none;' : ''">
                                <span x-text="(locale, t('gen.temperature.label'))"></span>: <span x-text="temperature.toFixed(1)"></span>
                                <input type="range" x-model.number="temperature" min="0.1" max="1.5" step="0.1"
                                    @input="saveGenerationParams()" style="width:100%;margin-top:6px;"
                                    :disabled="useProviderDefaults">
                                <div
                                    style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                    <span x-text="(locale, t('gen.focused'))"></span>
                                    <span x-text="(locale, t('gen.balanced'))"></span>
                                    <span x-text="(locale, t('gen.creative'))"></span>
                                </div>
                            </label>

                            <!-- Max Tokens -->
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:12px;"
                                :title="(locale, t('gen.maxLength.help'))"
                                :style="useProviderDefaults ? 'opacity:0.5;pointer-events:none;' : ''">
                                <span x-text="(locale, t('gen.maxLength.label'))"></span>: <span x-text="maxTokens"></span> <span x-text="(locale, t('gen.tokens'))"></span>
                                <input type="range" x-model.number="maxTokens" min="100" max="20000" step="100"
                                    @input="saveGenerationParams()" style="width:100%;margin-top:6px;"
                                    :disabled="useProviderDefaults">
                                <div
                                    style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:2px;">
                                    <span x-text="(locale, t('gen.length.short'))"></span>
                                    <span x-text="(locale, t('gen.length.medium'))"></span>
                                    <span x-text="(locale, t('gen.length.veryLong'))"></span>
                                </div>
                            </label>

                            <!-- Quick link to full AI Settings -->
                            <button class="btn btn-secondary" @click="showSceneOptions = false; showAISettings = true"
                                style="width:100%;font-size:11px;">
                                ‚öôÔ∏è <span x-text="(locale, t('ai.advancedSettings'))"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Context Panel Modal -->
        <template x-if="showContextPanel">
            <div class="modal-overlay" @click.self="showContextPanel = false">
                <div class="modal" x-data="{ allCompendiumEntries: [] }"
                    x-init="allCompendiumEntries = await getAllCompendiumEntries();"
                    style="max-width:1100px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
                    <div class="modal-header">
                        <h3 style="margin:0;">üìö <span x-text="(locale, t('context.panel.title'))"></span></h3>
                        <button class="btn btn-secondary" @click="showContextPanel = false" x-text="(locale, t('common.close'))"></button>
                    </div>
                    <div class="modal-body" style="overflow-y:auto;flex:1;">
                        <div style="margin-bottom:16px;">
                            <div style="font-size:13px;color:var(--text-secondary);">
                                <span x-text="(locale, t('context.panel.description'))"></span>
                            </div>
                        </div>

                        <!-- Two Column Layout -->
                        <div style="display:grid;grid-template-columns:380px 1fr;gap:20px;align-items:start;">
                            <!-- Left Column: Compendium -->
                            <div style="display:flex;flex-direction:column;">
                                <!-- Compendium Entries Section -->
                                <div
                                    style="background:var(--bg-secondary);padding:16px;border-radius:8px;border:1px solid var(--border);">
                                    <div
                                        style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
                                        <span>üìö</span>
                                        <span x-text="(locale, t('compendium.title'))"></span>
                                    </div>
                                    <div style="max-height:500px;overflow-y:auto;">
                                        <template x-if="allCompendiumEntries.length === 0">
                                            <div
                                                style="font-size:12px;color:var(--text-tertiary);padding:20px;text-align:center;">
                                                No compendium entries yet
                                            </div>
                                        </template>
                                        <template x-for="category in compendiumCategories" :key="category">
                                            <div x-show="allCompendiumEntries.filter(e => e.category === category).length > 0"
                                                style="margin-bottom:16px;">
                                                <div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;font-weight:700;letter-spacing:0.5px;"
                                                    x-text="category"></div>
                                                <template
                                                    x-for="entry in allCompendiumEntries.filter(e => e.category === category)"
                                                    :key="entry.id">
                                                    <label
                                                        style="display:flex;align-items:center;gap:10px;padding:8px 10px;cursor:pointer;border-radius:6px;font-size:13px;margin-bottom:4px;transition:all 0.15s;"
                                                        @mouseenter="$el.style.background = 'var(--bg-tertiary)'"
                                                        @mouseleave="$el.style.background = 'transparent'">
                                                        <input type="checkbox"
                                                            :checked="contextPanel.compendiumIds.includes(entry.id)"
                                                            @change="toggleContextCompendium(entry.id)"
                                                            style="cursor:pointer;width:16px;height:16px;">
                                                        <span x-text="entry.title" style="flex:1;"></span>
                                                    </label>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Scenes & Tags -->
                            <div style="display:flex;flex-direction:column;gap:16px;">
                                <!-- Scenes Section -->
                                <div
                                    style="background:var(--bg-secondary);padding:16px;border-radius:8px;border:1px solid var(--border);">
                                    <div
                                        style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
                                        <span>üìÑ</span>
                                        <span x-text="(locale, t('compendium.scenes'))"></span>
                                    </div>
                                    <div style="max-height:350px;overflow-y:auto;">
                                        <template x-if="chapters.length === 0">
                                            <div
                                                style="font-size:12px;color:var(--text-tertiary);padding:20px;text-align:center;">
                                                <span x-text="(locale, t('common.noScenes'))"></span>
                                            </div>
                                        </template>
                                        <template x-for="chapter in chapters" :key="chapter.id">
                                            <div style="margin-bottom:20px;">
                                                <!-- Chapter Header -->
                                                <div
                                                    style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding:8px 10px;background:var(--bg-tertiary);border-radius:6px;">
                                                    <div style="font-size:13px;font-weight:600;" x-text="chapter.title">
                                                    </div>
                                                    <div style="display:flex;gap:8px;">
                                                        <button
                                                            @click="setContextChapter(chapter.id, contextPanel.chapters[chapter.id] === 'full' ? null : 'full')"
                                                            :style="contextPanel.chapters[chapter.id] === 'full' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                            class="context-chapter-btn"
                                                            :title="(locale, t('context.includeFullAll'))">
                                                            üìÑ Full Text
                                                        </button>
                                                        <button
                                                            @click="setContextChapter(chapter.id, contextPanel.chapters[chapter.id] === 'summary' ? null : 'summary')"
                                                            :style="contextPanel.chapters[chapter.id] === 'summary' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                            class="context-chapter-btn"
                                                            :title="(locale, t('context.includeSummaryAll'))">
                                                            üìù Summary
                                                        </button>
                                                    </div>
                                                </div>
                                                <!-- Scenes List -->
                                                <template x-for="scene in chapter.scenes" :key="scene.id">
                                                    <div style="margin-left:12px;margin-bottom:6px;">
                                                        <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:5px;transition:all 0.15s;"
                                                            @mouseenter="$el.style.background = 'var(--bg-tertiary)'"
                                                            @mouseleave="$el.style.background = 'transparent'">
                                                            <div
                                                                style="font-size:13px;display:flex;align-items:center;gap:8px;flex:1;">
                                                                <span class="summary-dot"
                                                                    :class="{ 'has-summary': scene.summary, 'summary-stale': scene.summaryStale }"
                                                                    :title="scene.summary ? (scene.summaryStale ? t('summary.outdated') : t('summary.has')) : t('summary.none')"></span>
                                                                <span x-text="scene.title"></span>
                                                            </div>
                                                            <div style="display:flex;gap:6px;">
                                                                <button
                                                                    @click="setContextScene(scene.id, contextPanel.scenes[scene.id] === 'full' ? null : 'full')"
                                                                    :style="contextPanel.scenes[scene.id] === 'full' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                                    class="context-scene-btn" :title="(locale, t('context.includeFull'))">
                                                                üìÑ <span x-text="(locale, t('context.full'))"></span>
                                                                </button>
                                                                <button
                                                                    @click="setContextScene(scene.id, contextPanel.scenes[scene.id] === 'summary' ? null : 'summary')"
                                                                    :style="contextPanel.scenes[scene.id] === 'summary' ? 'background:var(--accent);color:white;font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);'"
                                                                    class="context-scene-btn" :title="(locale, t('context.includeSummary'))"
                                                                    :disabled="!scene.summary">
                                                                    üìù <span x-text="(locale, t('context.summary'))"></span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Tags Section -->
                                <div
                                    style="background:var(--bg-secondary);padding:16px;border-radius:8px;border:1px solid var(--border);">
                                    <div
                                        style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
                                        <span>üè∑Ô∏è</span>
                                        <span x-text="(locale, t('summary.tagsLabel'))"></span>
                                    </div>
                                    <template x-if="getAllTags().length === 0">
                                        <div
                                            style="font-size:12px;color:var(--text-tertiary);padding:20px;text-align:center;">
                                            <span x-text="(locale, t('context.noTagsHelp'))"></span>
                                        </div>
                                    </template>
                                    <div x-show="getAllTags().length > 0" style="display:flex;flex-wrap:wrap;gap:10px;">
                                        <template x-for="tag in getAllTags()" :key="tag">
                                            <button @click="toggleContextTag(tag)"
                                                :style="contextPanel.tags.includes(tag) ? 'background:var(--accent);color:white;border-color:var(--accent);font-weight:600;' : 'background:var(--bg-primary);color:var(--text-primary);border-color:var(--border);'"
                                                class="context-tag-btn"
                                                :title="contextPanel.tags.includes(tag) ? (t('context.tag.excludePrefix') + tag) : (t('context.tag.includePrefix') + tag)"
                                                @mouseenter="if (!contextPanel.tags.includes(tag)) $el.style.borderColor = 'var(--accent)'"
                                                @mouseleave="if (!contextPanel.tags.includes(tag)) $el.style.borderColor = 'var(--border)'"
                                                x-text="tag">
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </template>

    <!-- Workshop Chat Modal -->
    <template x-if="showWorkshopChat">
        <div class="modal-overlay" @click.self="showWorkshopChat = false" style="z-index:9000;"
            x-data="{ workshopMode: 'modal', workshopTemplateLoaded: false }" x-init="(async () => { 
                    await loadWorkshopSessions(); 
                    if (!workshopSessions || workshopSessions.length === 0) { 
                        workshopSessions = [window.workshopChat.createNewSession($data)]; 
                        await saveWorkshopSessions(); 
                    }
                    // Load template
                    const template = await window.TemplateLoader.load('workshop-chat');
                    $el.querySelector('.workshop-template-container').innerHTML = template;
                    workshopTemplateLoaded = true;
                })();">
            <div class="workshop-template-container" x-show="workshopTemplateLoaded"></div>
        </div>
    </template>
    </div>


</body>

</html>
